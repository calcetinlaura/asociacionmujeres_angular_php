<!-- Navegación del mes -->
<div class="max-w-4xl mx-auto p-4">
  <div class="flex items-center justify-between mb-4">
    <button
      (click)="prevMonth()"
      class="text-2xl px-2"
      aria-label="Mes anterior"
    >
      ‹
    </button>
    <h2 class="text-2xl font-bold text-center capitalize">
      {{ currentMonthLabel }}
    </h2>
    <button
      (click)="nextMonth()"
      class="text-2xl px-2"
      aria-label="Mes siguiente"
    >
      ›
    </button>
  </div>

  <!-- Días de la semana -->
  <div class="grid grid-cols-7 text-center text-gray-500 mb-2 font-semibold">
    <div>LU</div>
    <div>MA</div>
    <div>MI</div>
    <div>JU</div>
    <div>VI</div>
    <div>SA</div>
    <div>DO</div>
  </div>

  <!-- Días del calendario -->
  <div class="grid grid-cols-7 gap-2">
    @for (cell of calendar; track $index) {
    <div
      class="aspect-square bg-gray-100 relative overflow-hidden rounded-md hover:bg-lilaClaro"
      [ngClass]="{ 'ring-2 ring-blue-500': isToday(cell.date) }"
      (click)="openModalView(cell)"
      (mouseenter)="prefetchCell(cell)"
      (focusin)="prefetchCell(cell)"
      [class.cursor-pointer]="
        !!cell.date && (isDashboard || cell.events.length > 0)
      "
      [attr.role]="
        !!cell.date && (isDashboard || cell.events.length > 0) ? 'button' : null
      "
      [attr.tabindex]="
        !!cell.date && (isDashboard || cell.events.length > 0) ? 0 : null
      "
    >
      @if (cell.date) {
      <!-- Número del día -->
      <div
        class="absolute top-1 right-1 text-xs text-white bg-black bg-opacity-50 rounded px-1 z-10"
      >
        {{ cell.date.getDate() }}
      </div>

      <!-- CTA visual cuando está vacío en dashboard -->
      @if (isDashboard && cell.events.length === 0) {
      <div
        class="absolute inset-0 flex items-center justify-center pointer-events-none"
      >
        <span class="text-xs text-gray-600">-</span>
      </div>
      }

      <!-- Miniaturas de eventos -->
      <div class="w-full h-full flex flex-wrap">
        @for (event of cell.events; track $index) {
        <div
          class="relative"
          [ngStyle]="{
            width: getFlexBasis(cell.events.length),
            height: getFlexBasis(cell.events.length)
          }"
        >
          <div
            class="aspect-square bg-gray-100 relative overflow-hidden rounded-md"
            [ngClass]="{ 'ring-2 ring-blue-500': isToday(cell.date) }"
            (click)="$event.stopPropagation(); openModalView(cell)"
          >
            <img
              class="object-cover w-full h-full cursor-pointer"
              appImgBroken
              [src]="(event.img ? event.img : '') | itemImage : typeList.Events"
              [alt]="event.title || ''"
            />
          </div>
        </div>
        }
      </div>

      <!-- Overlay +N para abrir MultiEvents explícitamente -->
      @if (cell.events.length > 1) {
      <div
        class="cursor-pointer absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-sm font-bold text-black bg-[#c79cd3] bg-opacity-80 rounded p-4 z-20"
        (mouseenter)="prefetchCell(cell)"
        (click)="
          $event.stopPropagation();
          openMultiEventModal($event, cell.date!, cell.events)
        "
      >
        +{{ cell.events.length }}
      </div>
      } }
    </div>
    }
  </div>
</div>

<!-- Shell único para MultiEvents / Event -->
<app-modal-shell
  [visible]="shell.visible"
  [typeModal]="shell.typeModal"
  [action]="shell.action"
  [item]="shell.item"
  [canGoBack]="shell.canGoBack"
  [isDashboard]="isDashboard"
  (back)="onShellBack()"
  (close)="onShellClose()"
  (openEvent)="onOpenEvent($event)"
  (viewEvent)="onViewFromShell($event)"
  (editEvent)="onEditFromShell($event)"
  (removeEvent)="onRemoveFromShell($event)"
>
</app-modal-shell>
