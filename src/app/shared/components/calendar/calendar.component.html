<div class="max-w-4xl mx-auto p-4">
  <div class="flex items-center justify-between mb-4">
    <button
      (click)="prevMonth()"
      class="text-2xl px-2"
      aria-label="Mes anterior"
    >
      ‹
    </button>
    <h2 class="text-2xl font-bold text-center capitalize">
      {{ currentMonthLabel }}
    </h2>
    <button
      (click)="nextMonth()"
      class="text-2xl px-2"
      aria-label="Mes siguiente"
    >
      ›
    </button>
  </div>

  <div class="grid grid-cols-7 text-center text-gray-500 mb-2 font-semibold">
    <div>LU</div>
    <div>MA</div>
    <div>MI</div>
    <div>JU</div>
    <div>VI</div>
    <div>SA</div>
    <div>DO</div>
  </div>

  <div class="grid grid-cols-7 gap-2">
    @for (cell of calendar; track $index) {
    <div
      class="aspect-square bg-gray-100 relative overflow-hidden rounded-md hover:bg-lilaClaro"
      [ngClass]="{ 'ring-2 ring-blue-500': isToday(cell.date) }"
      (click)="openModalView(cell)"
      (mouseenter)="prefetchCell(cell)"
      (focusin)="prefetchCell(cell)"
      [class.cursor-pointer]="
        !!cell.date && (isDashboard || cell.events.length > 0)
      "
      [attr.role]="
        !!cell.date && (isDashboard || cell.events.length > 0) ? 'button' : null
      "
      [attr.tabindex]="
        !!cell.date && (isDashboard || cell.events.length > 0) ? 0 : null
      "
    >
      @if (cell.date) {
      <div
        class="absolute top-1 right-1 text-xs text-white bg-black bg-opacity-50 rounded px-1 z-10"
      >
        {{ cell.date.getDate() }}
      </div>

      @if (isDashboard && cell.events.length === 0) {
      <div
        class="absolute inset-0 flex items-center justify-center pointer-events-none"
      >
        <span class="text-xs text-gray-600">-</span>
      </div>
      }

      <div class="w-full h-full flex flex-wrap">
        @for (event of cell.events; track $index) {
        <div
          class="relative"
          [ngStyle]="{
            width: getFlexBasis(cell.events.length),
            height: getFlexBasis(cell.events.length)
          }"
        >
          <div
            class="aspect-square relative overflow-hidden rounded-md"
            [ngClass]="{ 'ring-2 ring-blue-500': isToday(cell.date) }"
            (click)="$event.stopPropagation(); openModalView(cell)"
          >
            @if (hasImg(event)) {
            <!-- Imagen de fondo -->
            <img
              class="object-cover w-full h-full cursor-pointer"
              appImgBroken
              loading="lazy"
              [src]="(event.img ? event.img : '') | itemImage : typeList.Events"
              [alt]="event.title || ''"
            />

            <!-- Overlay SOLO si borrador o programado -->
            @if (isDraft(event) || isScheduled(event)) {
            <div
              class="absolute inset-0 opacity-80"
              [ngClass]="{
                'bg-emerald-200': isDraft(event),
                'bg-yellow-200': isScheduled(event)
              }"
            ></div>
            } } @else {
            <!-- Sin imagen: fondo completo según estado -->
            <div
              class="w-full h-full"
              [ngClass]="{
                'bg-emerald-200': isDraft(event),
                'bg-yellow-200': isScheduled(event),
                'bg-gray-200': !isDraft(event) && !isScheduled(event)
              }"
            ></div>
            }
          </div>
        </div>
        }
      </div>

      @if (cell.events.length > 1) {
      <div
        class="cursor-pointer absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-sm font-bold text-black bg-brand bg-opacity-80 rounded p-4 z-20"
        (mouseenter)="prefetchCell(cell)"
        (click)="$event.stopPropagation(); openModalView(cell)"
      >
        +{{ cell.events.length }}
      </div>

      } }
    </div>
    }
  </div>
</div>
