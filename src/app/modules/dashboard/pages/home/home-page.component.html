@let vm = (vm$ | async); @if (vm) {
<div class="p-8">
  <!-- Encabezado -->
  <header class="flex flex-wrap items-center justify-between gap-3">
    <h1 class="title">Eventos</h1>
    <div class="control">
      <label>Año</label>
      <select [ngModel]="viewYear()" (ngModelChange)="onChangeYear($event)">
        <option [ngValue]="'historic'">Histórico</option>
        @for (year of years; track year) {
        <option [ngValue]="year">{{ year }}</option>
        }</select
      ><!-- ✅ Nuevo selector de tipo de vista -->
      <div class="flex items-center gap-3">
        <label class="inline-flex items-center cursor-pointer select-none">
          <input
            type="checkbox"
            class="sr-only peer"
            [ngModel]="view() === 'groupedByPeriodicId'"
            (ngModelChange)="onToggleView($event)"
          />

          <!-- SWITCH -->
          <div
            class="relative w-12 h-7 bg-gray-400 rounded-full peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-[transparent] after:content-[''] after:absolute after:top-[3px] after:left-[3px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-5 peer-checked:bg-[#cb8dd952]"
          ></div>

          <!-- TEXTO DINÁMICO -->
          <span
            class="ml-3 text-sm font-semibold transition-colors"
            [class.text-[#704f80]]="view() === 'groupedByPeriodicId'"
          >
            {{ view() === "groupedByPeriodicId" ? "Únicos" : "Repetidos" }}
          </span>
        </label>
      </div>

      <!-- Botón global de informe -->
      <app-icon-action
        [icon]="'uil-print'"
        [tooltip]="'Imprimir / Guardar PDF del informe completo'"
        (click)="printWholeReport()"
      ></app-icon-action>
    </div>
  </header>

  <div #reportRoot class="report-root flex flex-col gap-6">
    <!-- KPIs -->
    @if (eventsKpisState$ | async; as st) {
    <div class="flex gap-6 justify-between">
      <article class="card kpi flex-1">
        <div class="kpi-title">
          Eventos ({{ view() === "groupedByPeriodicId" ? "únicos" : "todos" }})
        </div>
        <div class="kpi-value">
          @if (st.loading) { <app-spinner-loading /> } @else {
          {{ st.data?.total }} }
        </div>
        <div class="kpi-sub">
          Promedio/mes: <strong>{{ st.data?.promedioMes }}</strong>
        </div>
      </article>

      @if (vm.kpis.proximoEvento; as next) {
      <article class="card kpi flex-1">
        <div class="kpi-title">Próximo evento</div>
        <div class="kpi-value ellipsis" [title]="next.title">
          {{ next.title }}
        </div>
        <div class="kpi-sub">{{ next.date | date : "EEE, d MMM" }}</div>
      </article>
      }

      <article class="card kpi flex-1">
        <div class="kpi-title">Borradores</div>
        <div class="kpi-value">{{ st.data?.drafts }}</div>
      </article>
      <article class="card kpi flex-1">
        <div class="kpi-title">
          Espacio con más eventos ({{
            view() === "groupedByPeriodicId" ? "únicos" : "todos"
          }})
        </div>
        <div class="kpi-value">
          @if (st.loading) { <app-spinner-loading /> } @else {
          {{ st.data?.espacioTop }}
          }
        </div>
        <div class="kpi-sub">
          @if (st.loading) { — } @else { {{ st.data?.espacioPerc }}% de los
          eventos }
        </div>
      </article>

      <article class="card kpi flex-1">
        <div class="kpi-title">
          Categoría más frecuente ({{
            view() === "groupedByPeriodicId" ? "únicos" : "todos"
          }})
        </div>
        <div class="kpi-value">
          @if (st.loading) { <app-spinner-loading /> } @else {
          {{ st.data?.categoriaTop | dictTranslate : dictType.Categories }}
          }
        </div>
        <div class="kpi-sub">
          @if (st.loading) { — } @else { {{ st.data?.categoriaPerc }}% de los
          eventos }
        </div>
      </article>

      <article class="card kpi flex-1">
        <div class="kpi-title">
          Mes con más eventos ({{
            view() === "groupedByPeriodicId" ? "únicos" : "todos"
          }})
        </div>
        <div class="kpi-value">
          @if (st.loading) { <app-spinner-loading /> } @else {
          {{ st.data?.mesTop }} }
        </div>
        <div class="kpi-sub">
          @if (st.loading) { — } @else { {{ st.data?.mesPerc }}% de los eventos
          }
        </div>
      </article>
    </div>
    }

    <!-- Donuts: Público / Acceso / Categorías -->
    <div class="flex gap-6 container-charts">
      <!-- Público -->
      <app-chart-card
        class="flex-1"
        [title]="'Público de los eventos (' + yearLabel() + ')'"
        [subtitle]="
          view() === 'groupedByPeriodicId'
            ? 'Solo eventos únicos'
            : 'Todos los eventos'
        "
      >
        <div card-actions>
          <app-icon-action
            [icon]="'uil-print'"
            [tooltip]="'Imprimir card'"
            (click)="
              printClosestCard(
                $event,
                'Público de los eventos (' + yearLabel() + ')'
              )
            "
          >
          </app-icon-action>
        </div>

        @if (audienceYearState$ | async; as st) { @if (st.loading) {
        <app-spinner-loading /> } @else if (st.error) {
        <div class="error">No se pudo cargar el gráfico.</div>
        } @else if (st.data?.length) {
        <app-donut-chart
          [data]="st.data"
          [title]="'Público de los eventos (' + yearLabel() + ')'"
        />
        } @else {
        <div class="muted">Sin datos.</div>
        } }
      </app-chart-card>

      <!-- Acceso -->
      <app-chart-card
        class="flex-1"
        [title]="'Acceso a los eventos (' + yearLabel() + ')'"
        [subtitle]="
          view() === 'groupedByPeriodicId'
            ? 'Solo eventos únicos'
            : 'Todos los eventos'
        "
      >
        <div card-actions>
          <app-icon-action
            [icon]="'uil-print'"
            [tooltip]="'Imprimir card'"
            (click)="
              printClosestCard(
                $event,
                'Acceso a los eventos (' + yearLabel() + ')'
              )
            "
          >
          </app-icon-action>
        </div>

        @if (eventsByAccessYearState$ | async; as st) { @if (st.loading) {
        <app-spinner-loading /> } @else if (st.error) {
        <div class="error">No se pudo cargar el gráfico.</div>
        } @else if (st.data?.length) {
        <app-donut-chart
          [data]="st.data"
          [labelType]="dictType.AccessType"
          [title]="'Acceso a los eventos (' + yearLabel() + ')'"
        />
        } @else {
        <div class="muted">Sin datos.</div>
        } }
      </app-chart-card>

      <!-- Categorías -->
      <app-chart-card
        class="flex-1"
        [title]="'Categorías de eventos (' + yearLabel() + ')'"
        [subtitle]="
          view() === 'groupedByPeriodicId'
            ? 'Solo eventos únicos'
            : 'Todos los eventos'
        "
      >
        <div card-actions>
          <app-icon-action
            [icon]="'uil-print'"
            [tooltip]="'Imprimir card'"
            (click)="
              printClosestCard(
                $event,
                'Categorías de eventos (' + yearLabel() + ')'
              )
            "
          >
          </app-icon-action>
        </div>

        @if (eventsByCategoryYearState$ | async; as st) { @if (st.loading) {
        <app-spinner-loading /> } @else if (st.error) {
        <div class="error">No se pudo cargar el gráfico.</div>
        } @else if (st.data?.length) {
        <app-donut-chart
          [data]="st.data"
          [labelType]="dictType.Categories"
          [title]="'Categorías de eventos (' + yearLabel() + ')'"
        />
        } @else {
        <div class="muted">Sin datos.</div>
        } }
      </app-chart-card>
    </div>

    <!-- EVENTOS -->
    <div class="flex flex-wrap gap-6 items-stretch">
      <!-- Eventos por mes -->
      <app-chart-card
        class="flex-[1] min-w-[320px]"
        [title]="'Eventos por mes (' + yearLabel() + ')'"
        [subtitle]="
          view() === 'groupedByPeriodicId'
            ? 'Solo eventos únicos'
            : 'Todos los eventos'
        "
      >
        <div card-actions>
          <app-icon-action
            [icon]="'uil-print'"
            [tooltip]="'Imprimir card'"
            (click)="
              printClosestCard($event, 'Eventos por mes (' + yearLabel() + ')')
            "
          >
          </app-icon-action>
        </div>

        @if (eventsByMonthState$ | async; as s) { @if (s.loading) {
        <app-spinner-loading /> } @else if (s.error) {
        <div class="error">No se pudo cargar el gráfico.</div>
        } @else {
        <app-monthly-chart
          [data]="s.data"
          [title]="'Eventos por mes (' + yearLabel() + ')'"
          [width]="0"
        />
        } }
      </app-chart-card>

      <!-- Eventos por espacio -->
      <app-chart-card
        class="flex-[2] min-w-[320px]"
        [title]="'Eventos por espacio (' + yearLabel() + ')'"
        [subtitle]="
          view() === 'groupedByPeriodicId'
            ? 'Solo eventos únicos'
            : 'Todos los eventos'
        "
        ariaDescription="Gráfico de barras horizontales con el total de eventos por espacio durante el año seleccionado"
        [footer]="false"
      >
        <div card-actions>
          <app-icon-action
            [icon]="'uil-print'"
            [tooltip]="'Imprimir card'"
            (click)="
              printClosestCard(
                $event,
                'Eventos por espacio (' + yearLabel() + ')'
              )
            "
          >
          </app-icon-action>
        </div>

        @if (eventsByPlaceHBarState$ | async; as s) { @if (s.loading) {
        <app-spinner-loading /> } @else if (s.error) {
        <div class="error">No se pudo cargar el gráfico.</div>
        } @else { <app-horizontal-bar-chart [data]="s.data" /> } }
      </app-chart-card>
    </div>
    <!-- Histórico: serie anual -->
    @if (viewYear() === 'historic') {
    <div class="flex flex-wrap gap-6 items-stretch">
      <app-chart-card
        class="flex-[2] min-w-[320px]"
        [title]="'Eventos por año (Histórico 2018–' + currentYear + ')'"
        [subtitle]="
          view() === 'groupedByPeriodicId'
            ? 'Solo eventos únicos'
            : 'Todos los eventos'
        "
      >
        <div card-actions>
          <app-icon-action
            [icon]="'uil-print'"
            [tooltip]="'Imprimir card'"
            (click)="
              printClosestCard(
                $event,
                'Eventos por año (Histórico 2018–' + currentYear + ')'
              )
            "
          >
          </app-icon-action>
        </div>

        @if (annualState$ | async; as series) { @if (series.loading) {
        <app-spinner-loading /> } @else if (series.error) {
        <div class="error">No se pudo cargar el gráfico.</div>
        } @else {
        <app-annual-line-chart
          [data]="series.data"
          [innerHeight]="110"
          [margin]="{ top: 6, right: 12, bottom: 18, left: 18 }"
          [yGridLines]="3"
          [compact]="true"
          [xTickFontSize]="6"
        />
        } }
      </app-chart-card>
    </div>
    }
    <!-- Libros, películas y recetas -->
    <section class="mt-16">
      <h1 class="title">Libros, películas, recetas y Piteras</h1>
      @if (cultureKpisState$ | async; as st) {
      <div class="flex gap-6 justify-between flex-wrap">
        <!-- Libros -->
        <article class="card kpi flex-1 min-w-[220px]">
          <div class="kpi-title">Libros donados ({{ yearLabel() }})</div>
          <div class="kpi-value">
            @if (st.loading) { — } @else if (viewYear() === 'historic') {
            {{ st.data?.books?.total }}
            } @else {
            {{ st.data?.books?.year }}
            }
          </div>
          <div class="kpi-sub">
            @if (!st.loading && viewYear() !== 'historic') {
            {{ st.data?.books?.total }} en total ·
            {{ st.data?.books?.perc | number : "1.0-2" }}% }
          </div>
        </article>

        <!-- Películas -->
        <article class="card kpi flex-1 min-w-[220px]">
          <div class="kpi-title">Películas donadas ({{ yearLabel() }})</div>
          <div class="kpi-value">
            @if (st.loading) { — } @else if (viewYear() === 'historic') {
            {{ st.data?.movies?.total }}
            } @else {
            {{ st.data?.movies?.year }}
            }
          </div>
          <div class="kpi-sub">
            @if (!st.loading && viewYear() !== 'historic') {
            {{ st.data?.movies?.total }} en total ·
            {{ st.data?.movies?.perc | number : "1.0-2" }}% }
          </div>
        </article>

        <!-- Recetas -->
        <article class="card kpi flex-1 min-w-[220px]">
          <div class="kpi-title">Recetas publicadas ({{ yearLabel() }})</div>
          <div class="kpi-value">
            @if (st.loading) { — } @else if (viewYear() === 'historic') {
            {{ st.data?.recipes?.total }}
            } @else {
            {{ st.data?.recipes?.year }}
            }
          </div>
          <div class="kpi-sub">
            @if (!st.loading && viewYear() !== 'historic') {
            {{ st.data?.recipes?.total }} en total ·
            {{ st.data?.recipes?.perc | number : "1.0-2" }}% }
          </div>
        </article>

        <!-- Pitera -->
        <article class="card kpi flex-1 min-w-[220px]">
          <div class="kpi-title">Pitera ({{ yearLabel() }})</div>

          <div class="kpi-value">
            @if (st.loading) { — } @else if (viewYear() === 'historic') {
            <strong
              >{{ st.data?.piteras?.totalIssuesAll }} publicaciones</strong
            >
            } @else {
            <strong>Nº {{ st.data?.piteras?.lastIssueNumberYear }}</strong>
            }
          </div>

          <div class="kpi-sub">
            @if (!st.loading && viewYear() !== 'historic') {
            {{ st.data?.piteras?.pagesYear }} páginas }
          </div>
        </article>
      </div>

      }
      <div class="flex flex-wrap gap-6 items-stretch w-full">
        <!-- Libros -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Libros donados por género (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Libros donados por género (' + yearLabel() + ')'
                )
              "
            >
            </app-icon-action>
          </div>

          @if (booksByGenreYearState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading /> } @else if (s.error) {
          <div class="error">No se pudieron cargar los datos.</div>
          } @else {
          <app-cheese-chart
            [data]="s.data"
            [size]="220"
            [rScale]="0.84"
            [labelOffset]="34"
            [labelMinGap]="10"
            [labelSideGap]="16"
            [margin]="{ top: 5, right: 40, bottom: 5, left: 40 }"
          />
          } }
        </app-chart-card>

        <!-- Películas -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Películas donadas por género (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Películas donadas por género (' + yearLabel() + ')'
                )
              "
            >
            </app-icon-action>
          </div>

          @if (moviesByGenreYearState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading /> } @else if (s.error) {
          <div class="error">No se pudieron cargar los datos.</div>
          } @else {
          <app-cheese-chart
            [data]="s.data"
            [size]="220"
            [rScale]="0.84"
            [labelOffset]="34"
            [labelMinGap]="10"
            [labelSideGap]="16"
            [margin]="{ top: 5, right: 40, bottom: 5, left: 40 }"
          />
          } }
        </app-chart-card>

        <!-- Recetas -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Recetas por categoría (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Recetas por categoría (' + yearLabel() + ')'
                )
              "
            >
            </app-icon-action>
          </div>

          @if (recipesByCategoryYearState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading /> } @else if (s.error) {
          <div class="error">No se pudieron cargar los datos.</div>
          } @else {
          <app-cheese-chart
            [data]="s.data"
            [size]="220"
            [rScale]="0.84"
            [labelOffset]="34"
            [labelMinGap]="10"
            [labelSideGap]="16"
            [margin]="{ top: 5, right: 40, bottom: 5, left: 40 }"
          />
          } }
        </app-chart-card>
      </div>
      @if (viewYear() === 'historic') {
      <div class="flex gap-6 container-charts">
        <!-- Páginas por número (Pitera) -->
        <app-chart-card
          class="flex-[3] min-w-[320px]"
          title="Páginas por número de Pitera"
          subtitle="Ordenado por edición"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="printClosestCard($event, 'Páginas por número de Pitera')"
            >
            </app-icon-action>
          </div>

          @if (pagesPerIssueState$ | async; as st) { @if (st.loading) {
          <app-spinner-loading /> } @else if (st.error) {
          <div class="error">No se pudo cargar el gráfico.</div>
          } @else if (st.data.length) {
          <app-annual-line-chart
            [data]="st.data"
            [innerHeight]="110"
            [margin]="{ top: 6, right: 12, bottom: 18, left: 18 }"
            [yGridLines]="3"
            [compact]="true"
            [title]="'Páginas por número'"
            [subtitle]="'Cada punto es un número de Pitera'"
            [xTickFontSize]="6"
          />
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>
      </div>
      }
    </section>

    <!-- Socias -->
    <section class="mt-16 flex flex-col gap-y-6">
      <h1 class="title">Socias</h1>
      @if (viewYear() !== 'historic') { @if (partnersKpisState$ | async; as st)
      {
      <div class="flex gap-6 justify-between">
        <article class="card kpi flex-1">
          <div class="kpi-title">Socias en {{ yearLabel() }}</div>
          <div class="kpi-value">
            @if (st.loading) { — } @else { {{ st.data?.sociasAnio ?? "—" }} }
          </div>
        </article>
        <article class="card kpi flex-1">
          <div class="kpi-title">Edad media ({{ yearLabel() }})</div>
          <div class="kpi-value">
            @if (st.loading) { — } @if (st.data?.edadMediaAnio != null) {
            {{ st.data!.edadMediaAnio | number : "1.0-1" }} años } @else { — }
          </div>
        </article>
        <article class="card kpi flex-1">
          <div class="kpi-title">Método pago más usado ({{ yearLabel() }})</div>
          <div class="kpi-value">
            @if (st.loading) { — } @else {
            {{ st.data?.metodoMasUsadoAnio ?? "—" }} }
          </div>
        </article>
        <article class="card kpi flex-1">
          <div class="kpi-title">Mes con más pagos ({{ yearLabel() }})</div>
          <div class="kpi-value">
            @if (st.loading) { — } @else {
            {{ monthName(st.data?.mesTopPagosAnio) }} }
          </div>
        </article>
      </div>
      }
      <div class="flex gap-6 container-charts">
        <!-- Métodos de pago -->
        <app-chart-card
          class="flex-1 min-w-[320px]"
          [title]="'Métodos de pago de cuotas (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Métodos de pago de cuotas (' + yearLabel() + ')'
                )
              "
            >
            </app-icon-action>
          </div>

          @if (paymentsByMethodState$ | async; as st) { @if (st.loading) {
          <app-spinner-loading /> } @else if (st.error) {
          <div class="error">No se pudieron cargar los datos.</div>
          } @else if (st.data?.length) {
          <app-cheese-chart
            [data]="st.data"
            [size]="220"
            [rScale]="0.84"
            [labelOffset]="34"
            [labelMinGap]="10"
            [labelSideGap]="16"
            [margin]="{ top: 5, right: 40, bottom: 5, left: 40 }"
          />
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>

        <!-- Pagos por mes -->
        <app-chart-card
          class="flex-1 min-w-[320px]"
          [title]="'Mes pago de cuota anual (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Mes pago de cuota anual (' + yearLabel() + ')'
                )
              "
            >
            </app-icon-action>
          </div>

          @if (paymentsByMonthState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading /> } @else if (s.error) {
          <div class="error">No se pudo cargar el gráfico.</div>
          } @else {
          <app-monthly-chart
            [data]="s.data"
            [title]="'Pago de cuota por meses (' + yearLabel() + ')'"
            [width]="0"
          />
          } } </app-chart-card
        ><!-- Distribución por edad (donut) -->
        <app-chart-card
          [title]="'Distribución por edad de socias (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Distribución por edad de socias (' + yearLabel() + ')'
                )
              "
            >
            </app-icon-action>
          </div>

          @if (partnersAgeBucketsState$ | async; as st) { @if (st.loading) {
          <app-spinner-loading /> } @else if (st.error) {
          <div class="error">No se pudo cargar el gráfico.</div>
          } @else if (st.data?.length) {
          <app-donut-chart
            [data]="st.data"
            [labelType]="dictType.PartnersAgeBuckets"
            [labelNormalize]="false"
            [title]="'Distribución por edad de socias (' + yearLabel() + ')'"
          />
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>
      </div>
      } @if (viewYear() === 'historic') {
      <div class="flex gap-6 container-charts">
        <!-- Socias por año -->
        <app-chart-card
          class="flex-1 min-w-[320px]"
          [title]="'Socias por año (1995–' + currentYear + ')'"
          [subtitle]="'Total de socias con cuota en el año'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Socias por año (1995–' + currentYear + ')'
                )
              "
            >
            </app-icon-action>
          </div>

          @if (partnersAnnualState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading /> } @else if (s.error) {
          <div class="error">No se pudo cargar el gráfico.</div>
          } @else {
          <app-annual-line-chart
            [data]="s.data"
            [innerHeight]="110"
            [margin]="{ top: 6, right: 12, bottom: 18, left: 18 }"
            [yGridLines]="3"
            [compact]="true"
            [title]="'Socias por año (1995–' + currentYear + ')'"
            [subtitle]="'Total de socias con cuota en el año'"
            [xTickFontSize]="6"
          />
          } }
        </app-chart-card>
      </div>
      }
    </section>
    <!-- Ingresos, gastos y subvenciones -->
    <section class="mt-16 flex flex-col gap-y-6">
      <h1 class="title">Ingresos, gastos y subvenciones</h1>
      @if (viewYear() !== 'historic') {
      <!-- KPIs -->
      @let kpis = economyKpis(); @if (kpis) {
      <div class="flex gap-6 justify-between">
        <article class="card kpi flex-1 min-w-[220px]">
          <div class="kpi-title">Ingresos totales ({{ yearLabel() }})</div>
          <div class="kpi-value">{{ kpis.ingresos | number : "1.0-2" }} €</div>
        </article>

        <article class="card kpi flex-1 min-w-[220px]">
          <div class="kpi-title">Gastos totales</div>
          <div class="kpi-value">{{ kpis.gastos | number : "1.0-2" }} €</div>
        </article>

        <article class="card kpi flex-1 min-w-[220px]">
          <div class="kpi-title">Subvenciones</div>
          <div class="kpi-value">
            {{ kpis.numSubvenciones | number : "1.0-0" }}
          </div>
          <div class="kpi-sub">
            {{ kpis.subvenciones | number : "1.0-2" }} €
          </div>
        </article>

        <article class="card kpi flex-1 min-w-[220px]">
          <div class="kpi-title">Balance</div>
          <div
            class="kpi-value"
            [style.color]="kpis.balance >= 0 ? '#16a34a' : '#dc2626'"
          >
            {{ kpis.balance | number : "1.0-2" }} €
          </div>
        </article>
      </div>
      }
      <div class="flex flex-wrap gap-6 items-stretch w-full">
        <!-- Distribución económica -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Distribución económica (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Distribución económica (' + yearLabel() + ')'
                )
              "
            ></app-icon-action>
          </div>

          @if (economyDonutByYearState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading />
          } @else if (s.error) {
          <div class="error">No se pudo cargar el gráfico.</div>
          } @else if (s.data?.length) {
          <app-cheese-chart
            [data]="s.data"
            [size]="220"
            [rScale]="0.84"
            [euro]="true"
            [showTotal]="false"
            [margin]="{ top: 0, right: 40, bottom: 0, left: 40 }"
          />
          <!-- 🟢 Nuevo bloque de balance -->
          @let balance = getBalanceFromDonut(s.data);

          <div
            class="mt-0 text-center font-semibold"
            [style.color]="balance >= 0 ? '#16a34a' : '#dc2626'"
          >
            {{ balance | number : "1.2-2" }} €
            <span class="block text-sm font-normal text-gray-600">
              Balance {{ balance >= 0 ? "positivo" : "negativo" }}
            </span>
          </div>
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>
        <!-- Gastos por proyecto -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Gastos por proyecto (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Gastos por proyecto (' + yearLabel() + ')'
                )
              "
            ></app-icon-action>
          </div>

          @if (expensesByProjectState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading />
          } @else if (s.error) {
          <div class="error">No se pudo cargar el gráfico.</div>
          } @else if (s.data?.length) {
          <app-donut-chart
            [data]="s.data"
            [title]="'Gastos por proyecto'"
            [euro]="true"
            [legendWidth]="270"
          />
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>
        <!-- Gastos -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Gastos por tipo (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Gastos por tipo (' + yearLabel() + ')'
                )
              "
            ></app-icon-action>
          </div>

          @if (expensesByTypeState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading />
          } @else if (s.error) {
          <div class="error">No se pudieron cargar los datos.</div>
          } @else if (s.data?.length) {
          <app-cheese-chart
            [data]="s.data"
            [size]="220"
            [rScale]="0.84"
            [euro]="true"
          />
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>
      </div>

      <div class="flex flex-wrap gap-6 items-stretch w-full">
        <!-- Ingresos -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Ingresos por tipo (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Ingresos por tipo (' + yearLabel() + ')'
                )
              "
            ></app-icon-action>
          </div>

          @if (incomeByTypeState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading />
          } @else if (s.error) {
          <div class="error">No se pudieron cargar los datos.</div>
          } @else if (s.data?.length) {
          <app-cheese-chart
            [data]="s.data"
            [size]="220"
            [rScale]="0.84"
            [euro]="true"
          />
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>

        <!-- Subvenciones por tipo -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Subvenciones por tipo (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Subvenciones por tipo (' + yearLabel() + ')'
                )
              "
            ></app-icon-action>
          </div>

          @if (subsidiesByTypeState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading />
          } @else if (s.error) {
          <div class="error">No se pudo cargar el gráfico.</div>
          } @else if (s.data?.length) {
          <app-donut-chart
            [data]="s.data"
            [title]="'Subvenciones por tipo'"
            [euro]="true"
          />
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>

        <!-- Ingresos por concepto -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Ingresos por concepto (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Ingresos por concepto (' + yearLabel() + ')'
                )
              "
            ></app-icon-action>
          </div>

          @if (incomeByConceptState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading />
          } @else if (s.error) {
          <div class="error">No se pudo cargar el gráfico.</div>
          } @else if (s.data?.length) {
          <app-donut-chart
            [data]="s.data"
            [title]="'Ingresos por concepto'"
            [euro]="true"
          />
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>
      </div>
      } @if (viewYear() === 'historic') {
      <div class="flex flex-wrap gap-6 items-stretch w-full">
        <!-- Comparativo -->
        <app-chart-card
          class="flex-[2] min-w-[320px]"
          [title]="'Comparativo económico por año'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard($event, 'Comparativo económico por año')
              "
            ></app-icon-action>
          </div>

          @if (economyByYearState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading />
          } @else if (s.error) {
          <div class="error">No se pudo cargar el gráfico.</div>
          } @else {
          <app-yearly-comparison-chart [data]="s.data ?? []" [euro]="true" />
          } }
        </app-chart-card>

        <!-- Balance anual -->
        <app-chart-card
          class="flex-[1] min-w-[640px]"
          [title]="'Balance anual (ingresos - gastos)'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard($event, 'Balance anual (ingresos - gastos)')
              "
            ></app-icon-action>
          </div>

          @if (economyByYearState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading />
          } @else if (s.error) {
          <div class="error">No se pudo cargar el gráfico.</div>
          } @else {
          <app-balance-by-year-chart [data]="s.data ?? []" [euro]="true" />
          } }
        </app-chart-card>
      </div>
      }
    </section>
  </div>
</div>
}
