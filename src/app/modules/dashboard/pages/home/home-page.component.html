@let vm = (vm$ | async); @if (vm) {
<section class="p-8">
  <!-- Encabezado -->
  <header class="flex flex-wrap items-center justify-between gap-3">
    <h1 class="title">Eventos</h1>
    <div class="control">
      <label>A√±o</label>
      <select [ngModel]="viewYear()" (ngModelChange)="onChangeYear($event)">
        <option [ngValue]="'historic'">Hist√≥rico</option>
        @for (year of years; track year) {
        <option [ngValue]="year">{{ year }}</option>
        }
      </select>
      <!-- Bot√≥n global de informe -->
      <app-icon-action
        [icon]="'uil-print'"
        [tooltip]="'Imprimir / Guardar PDF del informe completo'"
        (click)="printWholeReport()"
      ></app-icon-action>
    </div>
  </header>

  <div #reportRoot class="report-root flex flex-col gap-6">
    <!-- KPIs -->
    <div class="flex gap-6 justify-between">
      <article class="card kpi flex-1">
        <div class="kpi-title">
          Eventos ({{ view() === "groupedByPeriodicId" ? "√∫nicos" : "todos" }})
        </div>
        <div class="kpi-value">{{ vm.kpis.total }}</div>
        <div class="kpi-sub">
          Promedio/mes: <strong>{{ vm.kpis.promedioMes }}</strong>
        </div>
      </article>

      <article class="card kpi flex-1">
        <div class="kpi-title">√önicos</div>
        <div class="kpi-value">{{ vm.kpis.unicos }}</div>
        <div class="kpi-sub">
          Repetidos: <strong>{{ vm.kpis.repetidos }}</strong>
        </div>
      </article>

      @if (vm.kpis.proximoEvento; as next) {
      <article class="card kpi flex-1">
        <div class="kpi-title">Pr√≥ximo evento</div>
        <div class="kpi-value ellipsis" [title]="next.title">
          {{ next.title }}
        </div>
        <div class="kpi-sub">{{ next.date | date : "EEE, d MMM" }}</div>
      </article>
      }

      <article class="card kpi flex-1">
        <div class="kpi-title">Visibles ahora</div>
        <div class="kpi-value">{{ vm.visible.length }}</div>
        <div class="kpi-sub">
          Filtro: <strong>{{ keyword() || "‚Äî" }}</strong>
        </div>
      </article>
    </div>

    <!-- Donuts: P√∫blico / Acceso / Categor√≠as -->
    <div class="flex gap-6 container-charts">
      <!-- P√∫blico -->
      <app-chart-card
        class="flex-1"
        [title]="'P√∫blico de los eventos (' + yearLabel() + ')'"
      >
        <div card-actions>
          <app-icon-action
            [icon]="'uil-print'"
            [tooltip]="'Imprimir card'"
            (click)="
              printClosestCard(
                $event,
                'P√∫blico de los eventos (' + yearLabel() + ')'
              )
            "
          >
          </app-icon-action>
        </div>

        @if (audienceYearState$ | async; as st) { @if (st.loading) {
        <app-spinner-loading /> } @else if (st.error) {
        <div class="error">No se pudo cargar el gr√°fico.</div>
        } @else if (st.data?.length) {
        <app-donut-chart
          [data]="st.data"
          [title]="'P√∫blico de los eventos (' + yearLabel() + ')'"
        />
        } @else {
        <div class="muted">Sin datos.</div>
        } }
      </app-chart-card>

      <!-- Acceso -->
      <app-chart-card
        class="flex-1"
        [title]="'Acceso a los eventos (' + yearLabel() + ')'"
      >
        <div card-actions>
          <app-icon-action
            [icon]="'uil-print'"
            [tooltip]="'Imprimir card'"
            (click)="
              printClosestCard(
                $event,
                'Acceso a los eventos (' + yearLabel() + ')'
              )
            "
          >
          </app-icon-action>
        </div>

        @if (eventsByAccessYearState$ | async; as st) { @if (st.loading) {
        <app-spinner-loading /> } @else if (st.error) {
        <div class="error">No se pudo cargar el gr√°fico.</div>
        } @else if (st.data?.length) {
        <app-donut-chart
          [data]="st.data"
          [labelType]="dictType.AccessType"
          [title]="'Acceso a los eventos (' + yearLabel() + ')'"
        />
        } @else {
        <div class="muted">Sin datos.</div>
        } }
      </app-chart-card>

      <!-- Categor√≠as -->
      <app-chart-card
        class="flex-1"
        [title]="'Categor√≠as de eventos (' + yearLabel() + ')'"
      >
        <div card-actions>
          <app-icon-action
            [icon]="'uil-print'"
            [tooltip]="'Imprimir card'"
            (click)="
              printClosestCard(
                $event,
                'Categor√≠as de eventos (' + yearLabel() + ')'
              )
            "
          >
          </app-icon-action>
        </div>

        @if (eventsByCategoryYearState$ | async; as st) { @if (st.loading) {
        <app-spinner-loading /> } @else if (st.error) {
        <div class="error">No se pudo cargar el gr√°fico.</div>
        } @else if (st.data?.length) {
        <app-donut-chart
          [data]="st.data"
          [labelType]="dictType.Categories"
          [title]="'Categor√≠as de eventos (' + yearLabel() + ')'"
        />
        } @else {
        <div class="muted">Sin datos.</div>
        } }
      </app-chart-card>
    </div>

    <!-- Hist√≥rico: serie anual -->
    @if (viewYear() === 'historic') {
    <div class="flex flex-wrap gap-6 items-stretch">
      <app-chart-card
        class="flex-[2] min-w-[320px]"
        [title]="'Eventos por a√±o (Hist√≥rico 2018‚Äì' + currentYear + ')'"
        [subtitle]="
          view() === 'groupedByPeriodicId'
            ? 'Solo eventos √∫nicos'
            : 'Todos los eventos'
        "
      >
        <div card-actions>
          <app-icon-action
            [icon]="'uil-print'"
            [tooltip]="'Imprimir card'"
            (click)="
              printClosestCard(
                $event,
                'Eventos por a√±o (Hist√≥rico 2018‚Äì' + currentYear + ')'
              )
            "
          >
          </app-icon-action>
        </div>

        @if (annualState$ | async; as series) { @if (series.loading) {
        <app-spinner-loading /> } @else if (series.error) {
        <div class="error">No se pudo cargar el gr√°fico.</div>
        } @else {
        <app-annual-line-chart
          [data]="series.data"
          [innerHeight]="110"
          [margin]="{ top: 6, right: 12, bottom: 18, left: 18 }"
          [yGridLines]="3"
          [compact]="true"
          [xTickFontSize]="6"
        />
        } }
      </app-chart-card>
    </div>
    }

    <!-- EVENTOS -->
    <div class="flex flex-wrap gap-6 items-stretch">
      <!-- Eventos por mes -->
      <app-chart-card
        class="flex-[1] min-w-[320px]"
        [title]="'Eventos por mes (' + yearLabel() + ')'"
        [subtitle]="
          view() === 'groupedByPeriodicId'
            ? 'Solo eventos √∫nicos'
            : 'Todos los eventos'
        "
      >
        <div card-actions>
          <app-icon-action
            [icon]="'uil-print'"
            [tooltip]="'Imprimir card'"
            (click)="
              printClosestCard($event, 'Eventos por mes (' + yearLabel() + ')')
            "
          >
          </app-icon-action>
        </div>

        @if (eventsByMonthState$ | async; as s) { @if (s.loading) {
        <app-spinner-loading /> } @else if (s.error) {
        <div class="error">No se pudo cargar el gr√°fico.</div>
        } @else {
        <app-monthly-chart
          [data]="s.data"
          [title]="'Eventos por mes (' + yearLabel() + ')'"
          [width]="0"
        />
        } }
      </app-chart-card>

      <!-- Eventos por espacio -->
      <app-chart-card
        class="flex-[2] min-w-[320px]"
        [title]="'Eventos por espacio (' + yearLabel() + ')'"
        [subtitle]="
          view() === 'groupedByPeriodicId'
            ? 'Solo eventos √∫nicos'
            : 'Todos los eventos'
        "
        ariaDescription="Gr√°fico de barras horizontales con el total de eventos por espacio durante el a√±o seleccionado"
        [footer]="false"
      >
        <div card-actions>
          <app-icon-action
            [icon]="'uil-print'"
            [tooltip]="'Imprimir card'"
            (click)="
              printClosestCard(
                $event,
                'Eventos por espacio (' + yearLabel() + ')'
              )
            "
          >
          </app-icon-action>
        </div>

        @if (eventsByPlaceHBarState$ | async; as s) { @if (s.loading) {
        <app-spinner-loading /> } @else if (s.error) {
        <div class="error">No se pudo cargar el gr√°fico.</div>
        } @else { <app-horizontal-bar-chart [data]="s.data" /> } }
      </app-chart-card>
    </div>

    <!-- Libros, pel√≠culas y recetas -->
    <div class="mt-10">
      <h1 class="title mt-10">Libros, pel√≠culas, recetas y Piteras</h1>

      <div class="flex flex-wrap gap-6 items-stretch w-full">
        <!-- Libros -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Libros donados por g√©nero (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Libros donados por g√©nero (' + yearLabel() + ')'
                )
              "
            >
            </app-icon-action>
          </div>

          @if (booksByGenreYearState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading /> } @else if (s.error) {
          <div class="error">No se pudieron cargar los datos.</div>
          } @else {
          <app-cheese-chart
            [data]="s.data"
            [size]="220"
            [rScale]="0.84"
            [labelOffset]="34"
            [labelMinGap]="10"
            [labelSideGap]="16"
            [margin]="{ top: 5, right: 40, bottom: 5, left: 40 }"
          />
          } }
        </app-chart-card>

        <!-- Pel√≠culas -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Pel√≠culas donadas por g√©nero (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Pel√≠culas donadas por g√©nero (' + yearLabel() + ')'
                )
              "
            >
            </app-icon-action>
          </div>

          @if (moviesByGenreYearState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading /> } @else if (s.error) {
          <div class="error">No se pudieron cargar los datos.</div>
          } @else {
          <app-cheese-chart
            [data]="s.data"
            [size]="220"
            [rScale]="0.84"
            [labelOffset]="34"
            [labelMinGap]="10"
            [labelSideGap]="16"
            [margin]="{ top: 5, right: 40, bottom: 5, left: 40 }"
          />
          } }
        </app-chart-card>

        <!-- Recetas -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Recetas por categor√≠a (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Recetas por categor√≠a (' + yearLabel() + ')'
                )
              "
            >
            </app-icon-action>
          </div>

          @if (recipesByCategoryYearState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading /> } @else if (s.error) {
          <div class="error">No se pudieron cargar los datos.</div>
          } @else {
          <app-cheese-chart
            [data]="s.data"
            [size]="220"
            [rScale]="0.84"
            [labelOffset]="34"
            [labelMinGap]="10"
            [labelSideGap]="16"
            [margin]="{ top: 5, right: 40, bottom: 5, left: 40 }"
          />
          } }
        </app-chart-card>
      </div>

      <!-- P√°ginas por n√∫mero (Pitera) -->
      <app-chart-card
        class="flex-[3] min-w-[320px]"
        title="P√°ginas por n√∫mero de Pitera"
        subtitle="Ordenado por edici√≥n"
      >
        <div card-actions>
          <app-icon-action
            [icon]="'uil-print'"
            [tooltip]="'Imprimir card'"
            (click)="printClosestCard($event, 'P√°ginas por n√∫mero de Pitera')"
          >
          </app-icon-action>
        </div>

        @if (pagesPerIssueState$ | async; as st) { @if (st.loading) {
        <app-spinner-loading /> } @else if (st.error) {
        <div class="error">No se pudo cargar el gr√°fico.</div>
        } @else if (st.data.length) {
        <app-annual-line-chart
          [data]="st.data"
          [innerHeight]="110"
          [margin]="{ top: 6, right: 12, bottom: 18, left: 18 }"
          [yGridLines]="3"
          [compact]="true"
          [title]="'P√°ginas por n√∫mero'"
          [subtitle]="'Cada punto es un n√∫mero de Pitera'"
          [xTickFontSize]="6"
        />
        } @else {
        <div class="muted">Sin datos.</div>
        } }
      </app-chart-card>
    </div>

    <!-- Socias -->
    <div class="mt-10 flex flex-col gap-y-6">
      <h1 class="title">Socias</h1>

      <div class="flex gap-6 container-charts">
        @if (partnersKpisState$ | async; as st) {
        <div class="flex flex-col w-[400px] gap-y-2 container-articles">
          <article class="card kpi flex-1">
            <div class="kpi-title">Socias en {{ yearLabel() }}</div>
            <div class="kpi-value">
              @if (st.loading) { ‚Äî } @else { {{ st.data?.sociasAnio ?? "‚Äî" }} }
            </div>
          </article>
          <article class="card kpi flex-1">
            <div class="kpi-title">Edad media ({{ yearLabel() }})</div>
            <div class="kpi-value">
              @if (st.loading) { ‚Äî } @if (st.data?.edadMediaAnio != null) {
              {{ st.data!.edadMediaAnio | number : "1.0-1" }} a√±os } @else { ‚Äî }
            </div>
          </article>
          <article class="card kpi flex-1">
            <div class="kpi-title">
              M√©todo pago m√°s usado ({{ yearLabel() }})
            </div>
            <div class="kpi-value">
              @if (st.loading) { ‚Äî } @else {
              {{ st.data?.metodoMasUsadoAnio ?? "‚Äî" }} }
            </div>
          </article>
          <article class="card kpi flex-1">
            <div class="kpi-title">Mes con m√°s pagos ({{ yearLabel() }})</div>
            <div class="kpi-value">
              @if (st.loading) { ‚Äî } @else {
              {{ monthName(st.data?.mesTopPagosAnio) }} }
            </div>
          </article>
        </div>
        }

        <!-- M√©todos de pago -->
        <app-chart-card
          class="flex-1 min-w-[320px]"
          [title]="'M√©todos de pago de cuotas (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'M√©todos de pago de cuotas (' + yearLabel() + ')'
                )
              "
            >
            </app-icon-action>
          </div>

          @if (paymentsByMethodState$ | async; as st) { @if (st.loading) {
          <app-spinner-loading /> } @else if (st.error) {
          <div class="error">No se pudieron cargar los datos.</div>
          } @else if (st.data?.length) {
          <app-cheese-chart
            [data]="st.data"
            [size]="220"
            [rScale]="0.84"
            [labelOffset]="34"
            [labelMinGap]="10"
            [labelSideGap]="16"
            [margin]="{ top: 5, right: 40, bottom: 5, left: 40 }"
          />
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>

        <!-- Pagos por mes -->
        <app-chart-card
          class="flex-1 min-w-[320px]"
          [title]="'Mes pago de cuota anual (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Mes pago de cuota anual (' + yearLabel() + ')'
                )
              "
            >
            </app-icon-action>
          </div>

          @if (paymentsByMonthState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading /> } @else if (s.error) {
          <div class="error">No se pudo cargar el gr√°fico.</div>
          } @else {
          <app-monthly-chart
            [data]="s.data"
            [title]="'Pago de cuota por meses (' + yearLabel() + ')'"
            [width]="0"
          />
          } }
        </app-chart-card>
      </div>

      <div class="flex gap-6 container-charts">
        <!-- Distribuci√≥n por edad (donut) -->
        <app-chart-card
          [title]="'Distribuci√≥n por edad de socias (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Distribuci√≥n por edad de socias (' + yearLabel() + ')'
                )
              "
            >
            </app-icon-action>
          </div>

          @if (partnersAgeBucketsState$ | async; as st) { @if (st.loading) {
          <app-spinner-loading /> } @else if (st.error) {
          <div class="error">No se pudo cargar el gr√°fico.</div>
          } @else if (st.data?.length) {
          <app-donut-chart
            [data]="st.data"
            [labelType]="dictType.PartnersAgeBuckets"
            [labelNormalize]="false"
            [title]="'Distribuci√≥n por edad de socias (' + yearLabel() + ')'"
          />
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>

        <!-- Socias por a√±o -->
        <app-chart-card
          class="flex-1 min-w-[320px]"
          [title]="'Socias por a√±o (1995‚Äì' + currentYear + ')'"
          [subtitle]="'Total de socias con cuota en el a√±o'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Socias por a√±o (1995‚Äì' + currentYear + ')'
                )
              "
            >
            </app-icon-action>
          </div>

          @if (partnersAnnualState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading /> } @else if (s.error) {
          <div class="error">No se pudo cargar el gr√°fico.</div>
          } @else {
          <app-annual-line-chart
            [data]="s.data"
            [innerHeight]="110"
            [margin]="{ top: 6, right: 12, bottom: 18, left: 18 }"
            [yGridLines]="3"
            [compact]="true"
            [title]="'Socias por a√±o (1995‚Äì' + currentYear + ')'"
            [subtitle]="'Total de socias con cuota en el a√±o'"
            [xTickFontSize]="6"
          />
          } }
        </app-chart-card>
      </div>
    </div>
    <!-- Ingresos, gastos y subvenciones -->
    <div class="mt-10 flex flex-col gap-y-6">
      <h1 class="title">Ingresos, gastos y subvenciones</h1>
      <div class="flex flex-wrap gap-6 items-stretch w-full">
        <!-- Distribuci√≥n econ√≥mica -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Distribuci√≥n econ√≥mica (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Distribuci√≥n econ√≥mica (' + yearLabel() + ')'
                )
              "
            ></app-icon-action>
          </div>

          @if (economyDonutByYearState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading />
          } @else if (s.error) {
          <div class="error">No se pudo cargar el gr√°fico.</div>
          } @else if (s.data?.length) {
          <app-cheese-chart
            [data]="s.data"
            [size]="220"
            [rScale]="0.84"
            [euro]="true"
            [showTotal]="false"
            [margin]="{ top: 0, right: 40, bottom: 0, left: 40 }"
          />
          <!-- üü¢ Nuevo bloque de balance -->
          @let balance = getBalanceFromDonut(s.data);

          <div
            class="mt-0 text-center font-semibold"
            [style.color]="balance >= 0 ? '#16a34a' : '#dc2626'"
          >
            {{ balance | number : "1.2-2" }} ‚Ç¨
            <span class="block text-sm font-normal text-gray-600">
              Balance {{ balance >= 0 ? "positivo" : "negativo" }}
            </span>
          </div>
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>
        <!-- Gastos por proyecto -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Gastos por proyecto (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Gastos por proyecto (' + yearLabel() + ')'
                )
              "
            ></app-icon-action>
          </div>

          @if (expensesByProjectState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading />
          } @else if (s.error) {
          <div class="error">No se pudo cargar el gr√°fico.</div>
          } @else if (s.data?.length) {
          <app-donut-chart
            [data]="s.data"
            [title]="'Gastos por proyecto'"
            [euro]="true"
            [legendWidth]="270"
          />
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>
        <!-- Gastos -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Gastos por tipo (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Gastos por tipo (' + yearLabel() + ')'
                )
              "
            ></app-icon-action>
          </div>

          @if (expensesByTypeState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading />
          } @else if (s.error) {
          <div class="error">No se pudieron cargar los datos.</div>
          } @else if (s.data?.length) {
          <app-cheese-chart
            [data]="s.data"
            [size]="220"
            [rScale]="0.84"
            [euro]="true"
          />
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>
      </div>

      <div class="flex flex-wrap gap-6 items-stretch w-full">
        <!-- Ingresos -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Ingresos por tipo (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Ingresos por tipo (' + yearLabel() + ')'
                )
              "
            ></app-icon-action>
          </div>

          @if (incomeByTypeState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading />
          } @else if (s.error) {
          <div class="error">No se pudieron cargar los datos.</div>
          } @else if (s.data?.length) {
          <app-cheese-chart
            [data]="s.data"
            [size]="220"
            [rScale]="0.84"
            [euro]="true"
          />
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>

        <!-- Subvenciones por tipo -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Subvenciones por tipo (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Subvenciones por tipo (' + yearLabel() + ')'
                )
              "
            ></app-icon-action>
          </div>

          @if (subsidiesByTypeState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading />
          } @else if (s.error) {
          <div class="error">No se pudo cargar el gr√°fico.</div>
          } @else if (s.data?.length) {
          <app-donut-chart
            [data]="s.data"
            [title]="'Subvenciones por tipo'"
            [euro]="true"
          />
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>

        <!-- Ingresos por concepto -->
        <app-chart-card
          class="flex-[1] min-w-[320px]"
          [title]="'Ingresos por concepto (' + yearLabel() + ')'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard(
                  $event,
                  'Ingresos por concepto (' + yearLabel() + ')'
                )
              "
            ></app-icon-action>
          </div>

          @if (incomeByConceptState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading />
          } @else if (s.error) {
          <div class="error">No se pudo cargar el gr√°fico.</div>
          } @else if (s.data?.length) {
          <app-donut-chart
            [data]="s.data"
            [title]="'Ingresos por concepto'"
            [euro]="true"
          />
          } @else {
          <div class="muted">Sin datos.</div>
          } }
        </app-chart-card>
      </div>
      <div class="flex flex-wrap gap-6 items-stretch w-full">
        <!-- Comparativo -->
        <app-chart-card
          class="flex-[2] min-w-[320px]"
          [title]="'Comparativo econ√≥mico por a√±o'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard($event, 'Comparativo econ√≥mico por a√±o')
              "
            ></app-icon-action>
          </div>

          @if (economyByYearState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading />
          } @else if (s.error) {
          <div class="error">No se pudo cargar el gr√°fico.</div>
          } @else {
          <app-yearly-comparison-chart [data]="s.data ?? []" [euro]="true" />
          } }
        </app-chart-card>

        <!-- Balance anual -->
        <app-chart-card
          class="flex-[1] min-w-[640px]"
          [title]="'Balance anual (ingresos - gastos)'"
        >
          <div card-actions>
            <app-icon-action
              [icon]="'uil-print'"
              [tooltip]="'Imprimir card'"
              (click)="
                printClosestCard($event, 'Balance anual (ingresos - gastos)')
              "
            ></app-icon-action>
          </div>

          @if (economyByYearState$ | async; as s) { @if (s.loading) {
          <app-spinner-loading />
          } @else if (s.error) {
          <div class="error">No se pudo cargar el gr√°fico.</div>
          } @else {
          <app-balance-by-year-chart [data]="s.data ?? []" [euro]="true" />
          } }
        </app-chart-card>
      </div>
    </div>
  </div>
</section>
}
