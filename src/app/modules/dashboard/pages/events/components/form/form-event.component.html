<div class="flex flex-col">
  <div class="text-center pb-5 uppercase">
    <p class="text-2xl">{{ titleForm }}</p>
  </div>

  @if (isLoading) {
  <div class="spinner-container">
    <app-spinner-loading />
  </div>
  } @else {
  <form
    appScrollToFirstError
    (ngSubmit)="onSendFormEvent()"
    [formGroup]="formEvent"
    class="login-auth-form"
  >
    <div class="flex flex-col gap-y-4">
      <div class="flex justify-between gap-x-8 h-[420px]">
        <div class="flex flex-col flex-1 gap-y-4">
          <div>
            <label for="title">Título</label>
            <div class="flex w-full box-input">
              <input
                formControlName="title"
                placeholder="Título del evento"
                type="text"
                [ngClass]="{
                  'is-invalid': submitted && formEvent.get('title')?.invalid
                }"
                class="w-full"
              />
            </div>
            @if (submitted && formEvent.get('title')?.invalid) {
            <div class="is-invalid-text">Campo requerido</div>
            }
          </div>
          <div>
            <label for="description" class="mt-4">Descripción</label>
            <div class="flex-1">
              <quill-editor
                formControlName="description"
                [modules]="quillModules"
                placeholder="Escribe aquí la descripción..."
                class="ql-container-small text-sm focus:outline-none focus:ring focus:ring-blue-200 w-full"
              />
            </div>
            <div class="text-right text-xs text-gray-500 mt-1">
              {{ descriptionLen() }} / 2000
            </div>
          </div>
          <div>
            <label for="summary" class="mt-4"
              >Resumen
              <span class="text-[9px]">(Texto para redes sociales)</span></label
            >
            <!-- Resumen (corto) -->
            <div class="box-input gap-x-4 flex-1 !items-start">
              <textarea
                formControlName="summary"
                maxlength="300"
                rows="3"
                placeholder="Resumen breve del evento (máx. 300 caracteres visibles)"
                class="ql-container-mini text-sm focus:outline-none focus:ring focus:ring-blue-200 w-full"
              ></textarea>
            </div>
            <div class="text-right text-xs text-gray-500 mt-1">
              {{ summaryLen() }} / 300
            </div>
          </div>
        </div>

        <div class="w-72">
          <app-image-control
            [previewImg]="formEvent.get('img')?.value || null"
            [entityId]="itemId"
            [type]="typeList"
            (imgSelected)="onImageSelected($event)"
            [imageWidthValue]="'full'"
            [imageHeightValue]="410"
            [textImg]="'Añadir cartel'"
            class="w-full"
          ></app-image-control>
        </div>
      </div>

      <!-- FECHA -->
      <div
        id="dateSection"
        class="border-2 pt-2 px-4 pb-6 mb-6"
        [ngClass]="{
            'border-[red]': submitted && (
              !isTypePeriodSelected ||
              formEvent.errors?.['periodicNeedsAtLeastTwoDates'] ||
              formEvent.errors?.['invalidDateRange'] ||
              formEvent.errors?.['invalidTimeRange'] ||
              repeatedDates.errors?.['duplicateStartDatesAndTimes'] ||
              formEvent.get('start')?.invalid ||
              formEvent.get('end')?.invalid
            )
          }"
        [attr.aria-invalid]="submitted && (
              formEvent.errors?.['periodicNeedsAtLeastTwoDates'] ||
              formEvent.errors?.['invalidDateRange'] ||
              formEvent.errors?.['invalidTimeRange'] ||
              !isTypePeriodSelected
            ) ? 'true' : null"
      >
        <h2 class="font-bold text-lilaText mt-4 uppercase">Fecha y hora</h2>
        <div class="flex justify-center gap-x-4 py-2">
          <app-button-select
            [buttonText]="'Evento individual'"
            subText="Para eventos que ocurren una vez"
            [active]="eventTypePeriod === 'single'"
            (addClicked)="setEventTypePeriod('single')"
            iconClass="uil-calender"
          >
          </app-button-select>

          <app-button-select
            [buttonText]="'Evento recurrente'"
            subText="Se repite en varias ocasiones"
            [active]="eventTypePeriod === 'periodic'"
            (addClicked)="setEventTypePeriod('periodic')"
            iconClass="uil-calendar-alt"
          >
          </app-button-select>
        </div>

        @if(submitted && !isTypePeriodSelected){
        <div class="flex justify-center gap-x-4 py-2">
          <p class="is-invalid-text">Debes seleccionar una opción</p>
        </div>
        }

        <!-- Pase único -->
        @if (eventTypePeriod === 'single') {
        <div class="pt-4 px-4">
          <p class="text-[12px] text-center mb-10 text-lilaText px-4">
            Si el evento es de un solo día, no es necesario indicar una fecha de
            fin. Además, si no se especifica la hora de finalización, el sistema
            asignará automáticamente una duración de 3 horas a partir de la hora
            de inicio.
          </p>

          <div class="flex gap-x-4">
            <!-- Fecha inicio -->
            <div class="flex flex-1 gap-x-4 items-center">
              <label
                class="py-2 px-4 rounded-xl text-sm text-lilaText bg-lilaMuyClaro w-auto"
                for="start"
                >Fecha Inicio</label
              >
              <div class="flex-1 flex flex-col box-input">
                <input
                  formControlName="start"
                  type="date"
                  [ngClass]="{
                    'text-placeholder': !formEvent.get('start')?.value,
                    'is-invalid': submitted && formEvent.get('start')?.invalid
                  }"
                />
                <div class="w-full text-left pl-4">
                  @if (submitted &&
                  formEvent.get('start')?.hasError('required')) {
                  <div class="is-invalid-text">Campo requerido</div>
                  } @if (submitted &&
                  formEvent.get('start')?.hasError('minDate')) {
                  <div class="is-invalid-text">Debe ser desde 01/01/2018.</div>
                  } @if (submitted &&
                  formEvent.get('start')?.hasError('maxDate')) {
                  <div class="is-invalid-text">
                    Debe ser fecha máxima próximo año.
                  </div>
                  }
                </div>
              </div>
            </div>

            <!-- Fecha fin -->
            <div class="flex flex-1 gap-x-4 items-center">
              <label
                class="py-2 px-4 rounded-xl text-sm text-lilaText bg-lilaMuyClaro"
                for="end"
                >Fecha Fin</label
              >
              <div class="flex-1 box-input">
                <input
                  formControlName="end"
                  type="date"
                  [ngClass]="{
                    'text-placeholder': !formEvent.get('end')?.value,
                    'is-invalid': submitted && formEvent.get('end')?.invalid
                  }"
                />
                @if (submitted && formEvent.get('end')?.hasError('minDate')) {
                <div class="is-invalid-text">Debe ser desde 01/01/2018.</div>
                } @if (submitted && formEvent.get('end')?.hasError('maxDate')) {
                <div class="is-invalid-text">
                  Debe ser fecha máxima próximo año.
                </div>
                } @if (submitted && formEvent.hasError('invalidDateRange')) {
                <p class="is-invalid-text">
                  La fecha fin no puede ser anterior a la fecha de inicio
                </p>
                }
              </div>
            </div>

            <!-- Hora inicio -->
            <div class="flex gap-x-4 items-center">
              <label
                class="py-2 px-4 rounded-xl text-sm text-lilaText bg-lilaMuyClaro"
                for="time_start"
                >Hora Inicio</label
              >
              <div class="flex-1 box-input">
                <input
                  formControlName="time_start"
                  type="time"
                  class="w-full p-1 border rounded"
                  placeholder="00:00"
                />
              </div>
            </div>

            <!-- Hora fin -->
            <div class="flex flex-col">
              <div class="flex flex-1 gap-x-4 items-center">
                <label
                  class="py-2 px-4 rounded-xl text-sm text-lilaText bg-lilaMuyClaro"
                  for="time_end"
                  >Hora Fin</label
                >
                <div class="flex-1 flex flex-col box-input">
                  <input
                    formControlName="time_end"
                    type="time"
                    class="w-full p-1 border rounded"
                    placeholder="00:00"
                    [ngClass]="{
                          'is-invalid': submitted && formEvent.errors?.['invalidTimeRange']
                        }"
                  />
                </div>
              </div>

              @if (submitted && formEvent.errors?.['invalidTimeRange']) {
              <p class="is-invalid-text">
                La hora fin no puede ser anterior a inicio
              </p>
              }
            </div>
          </div>
        </div>
        }

        <!-- Evento periódico -->
        @if (eventTypePeriod === 'periodic') {
        <div
          formArrayName="repeated_dates"
          class="flex flex-col gap-y-4 pt-8 px-4 items-center"
        >
          <app-date-array-control
            [formArray]="repeatedDates"
            [submitted]="submitted"
            (remove)="removeRepeatedDate($event)"
          ></app-date-array-control>

          @if (submitted && formEvent.errors?.['periodicNeedsAtLeastTwoDates'])
          {
          <div class="text-center">
            <p class="is-invalid-text">
              Un evento periódico debe tener al menos dos fechas. Si es solo una
              fecha pasar a evento de pase único.
            </p>
          </div>
          }

          <div class="flex justify-center">
            <app-button-icon
              [buttonText]="'Añadir fecha'"
              [iconClass]="'uil-plus'"
              (addClicked)="addRepeatedDate()"
            ></app-button-icon>
          </div>
        </div>
        }
      </div>

      <!-- CATEGORÍA -->
      <div
        class="border-2 pt-2 px-4 pb-6 mb-6"
        [ngClass]="{
          'border-[red]': submitted && categoryCtrl.hasError('required')
        }"
      >
        <h2 class="font-bold text-lilaText my-4 uppercase">Categoría</h2>
        <p class="text-[12px] text-center mb-10 text-lilaText px-4">
          Un evento puede estar clasificado en más de una categoría.
        </p>
        <div class="grid grid-cols-5 gap-4 mx-16">
          @for (category of category_list; track category.code) {
          <div class="w-full">
            <app-button-category
              class="w-full h-full"
              [code]="category.code"
              [buttonText]="category.label"
              [iconClass]="category.icon"
              [active]="isCategoryActive(category.code)"
              (addClicked)="toggleCategory($event)"
            />
          </div>
          }
        </div>

        @if (submitted && categoryCtrl.hasError('required')) {
        <div class="is-invalid-text text-center">
          Selecciona al menos una categoría
        </div>
        }
      </div>

      <!-- UBICACION -->
      <div class="border-2 pt-2 px-4 pb-6 mb-6">
        <h2 class="font-bold text-lilaText mt-4 uppercase">Ubicación</h2>

        <div class="flex justify-center gap-x-4 py-2">
          <app-button-select
            [buttonText]="'Lugar'"
            [active]="eventTypeUbication === 'PLACE'"
            (addClicked)="setEventTypeUbication('PLACE')"
            iconClass="uil-map-marker"
          />
          <app-button-select
            [buttonText]="'Evento online'"
            [active]="eventTypeUbication === 'ONLINE'"
            (addClicked)="setEventTypeUbication('ONLINE')"
            iconClass="uil-presentation-play"
          />
          <app-button-select
            [buttonText]="'Por anunciar'"
            [active]="eventTypeUbication === 'PENDING'"
            (addClicked)="setEventTypeUbication('PENDING')"
            iconClass="uil-megaphone"
          />
        </div>

        @if (eventTypeUbication === 'PLACE') {
        <div class="flex flex-col px-4 pt-6 gap-y-4">
          <!-- Provincia -->
          <div class="box-input gap-x-4 flex flex-1">
            <label for="province">Provincia</label>
            <select
              formControlName="province"
              (change)="onProvinceChange()"
              [ngClass]="{
                'is-invalid': submitted && formEvent.get('province')?.invalid,
                'text-placeholder': !formEvent.get('province')?.value
              }"
            >
              <option value="" disabled hidden>Seleccione una provincia</option>
              <option value="">Sin provincia</option>
              @for (prov of provincias; track trackByLabel($index, prov)) {
              <option [value]="prov.label">{{ prov.label }}</option>
              }
            </select>
            @if (submitted && formEvent.get('province')?.invalid) {
            <div class="is-invalid-text">Campo requerido</div>
            }
          </div>

          <!-- Municipio -->
          <div class="box-input flex flex-1 gap-x-4">
            <label for="town">Municipio</label>
            <select
              formControlName="town"
              (change)="onTownChange()"
              [ngClass]="{
                'is-invalid': submitted && formEvent.get('town')?.invalid,
                'text-placeholder': !formEvent.get('town')?.value
              }"
            >
              <option value="" disabled hidden>Seleccione un municipio</option>
              <option value="">Sin municipio</option>
              @for (mun of municipios; track trackByLabel($index, mun)) {
              <option [value]="mun.label">{{ mun.label }}</option>
              }
            </select>
            @if (submitted && formEvent.get('town')?.invalid) {
            <div class="is-invalid-text">Campo requerido</div>
            }
          </div>

          <!-- Espacio -->
          <div class="box-input gap-x-4">
            <label for="place">Espacio</label>
            <select formControlName="place_id" (change)="onPlaceChange()">
              <option [ngValue]="null" disabled>Selecciona un espacio</option>
              @for (place of espacios; track trackById($index, place)) {
              <option [ngValue]="place.id">{{ place.name }}</option>
              }
            </select>
          </div>

          <!-- Sala -->
          @if (salasDelLugar.length > 0) {
          <div class="box-input gap-x-4">
            <label for="sala">Sala</label>
            <select formControlName="sala_id" (change)="onSalaChange()">
              <option [ngValue]="null" disabled>Selecciona una sala</option>
              @for (sala of salasDelLugar; track trackBySalaId ($index, sala)) {
              <option [ngValue]="sala.sala_id">
                {{ sala.name }} -
                {{
                  sala.room_location
                    | filterTransformCode : "roomLocationPlaces"
                }}
              </option>
              }
            </select>
          </div>
          }

          <!-- Aforo -->
          <div class="box-input gap-y-2 gap-x-4">
            <label for="capacity">Aforo</label>
            <input formControlName="capacity" type="number" min="0" />
          </div>
        </div>
        } @if (eventTypeUbication === 'ONLINE') {
        <app-link-item
          [standalone]="true"
          [urlCtrl]="onlineLinkCtrl"
          [textCtrl]="onlineTitleCtrl"
          [submitted]="submitted"
          urlPlaceholder="https://..."
          textLabel="Título"
          textPlaceholder="Título de la página web"
          [showRemove]="false"
        />
        }
      </div>

      <!-- MACRO -->
      <div class="border-2 pt-2 px-4 pb-6 mb-6">
        <h2 class="font-bold text-lilaText mt-4 uppercase">Macroevento</h2>
        <div class="flex justify-center gap-x-4 py-2">
          <app-button-select
            [buttonText]="'No está dentro de un macroevento'"
            subText="Es un evento único"
            [active]="eventTypeMacro === 'SINGLE'"
            (addClicked)="setEventTypeMacro('SINGLE')"
            iconClass="uil-calendar-alt"
          />
          <app-button-select
            [buttonText]="'Está dentro de un macroevento'"
            subText="Está dentro de una programación más amplia"
            [active]="eventTypeMacro === 'MACRO'"
            (addClicked)="setEventTypeMacro('MACRO')"
            iconClass="uil-calendar-alt"
          />
        </div>

        @if (eventTypeMacro === 'MACRO') {
        <div class="pt-4 px-4">
          <p class="text-[12px] text-center mb-10 text-lilaText px-4">
            Si el macroevento al que pertenece el evento no aparece se debe
            registar previamente el macroevento desde la sección de
            MACROEVENTOS.
          </p>

          <div class="flex gap-x-8">
            <div class="box-input gap-x-4 flex flex-1">
              <label for="province">Macroevento</label>
              <div class="flex flex-col flex-1">
                <select formControlName="macroevent_id">
                  <option [ngValue]="null">Seleccione un macroevento</option>
                  @for (macro of macroevents; track macro) {
                  <option [ngValue]="macro.id">
                    {{ macro.title }} - {{ macro.start | date : "yyyy" }}
                  </option>
                  }
                </select>

                @if (formEvent.controls.macroevent_id.disabled) {
                <div>
                  <small class="text-gray-500 italic">
                    Selecciona una fecha de inicio para habilitar los
                    macroeventos de ese año
                  </small>
                </div>
                }
              </div>
            </div>
          </div>
        </div>
        }
      </div>

      <!-- PROYECTO -->
      <div class="border-2 pt-2 px-4 pb-6 mb-6">
        <h2 class="font-bold text-lilaText mt-4 uppercase">Proyecto</h2>
        <div class="flex justify-center gap-x-4 py-2">
          <app-button-select
            [buttonText]="'No está dentro de un proyecto'"
            subText="Es un evento único"
            [active]="eventTypeProject === 'NO_PROJECT'"
            (addClicked)="setEventTypeProject('NO_PROJECT')"
            iconClass="uil-calendar-alt"
          />
          <app-button-select
            [buttonText]="'Está dentro de un proyecto'"
            subText="Está dentro de una programación más amplia"
            [active]="eventTypeProject === 'PROJECT'"
            (addClicked)="setEventTypeProject('PROJECT')"
            iconClass="uil-calendar-alt"
          />
        </div>

        @if (eventTypeProject === 'PROJECT') {
        <div class="pt-4 px-4">
          <p class="text-[12px] text-center mb-10 text-lilaText px-4">
            Si el proyecto al que pertenece el evento no aparece se debe
            registrar previamente el proyecto desde la sección de PROYECTOS.
          </p>

          <div class="flex gap-x-8">
            <div class="box-input gap-x-4 flex flex-1">
              <label for="province">Proyecto</label>
              <div class="flex flex-col flex-1">
                <select formControlName="project_id">
                  <option [ngValue]="null">
                    Seleccione una subvención si el proyecto pertenece a alguna
                  </option>
                  @for (project of projects; track project) {
                  <option [value]="project.id">
                    {{ project.title }} - {{ project.year }}
                  </option>
                  }
                </select>

                @if (formEvent.controls.project_id.disabled) {
                <div>
                  <small class="text-gray-500 italic">
                    Selecciona una fecha de inicio para habilitar los proyectos
                    de ese año
                  </small>
                </div>
                }
              </div>
            </div>
          </div>
        </div>
        }
      </div>

      <!-- PÚBLICO -->
      <div
        id="audienceSection"
        class="border-2 pt-2 px-4 pb-6 mb-6"
        [ngClass]="{ 'border-[red]': submitted && audienceErrorMessage }"
        [attr.aria-invalid]="
          submitted && !!audienceErrorMessage ? 'true' : null
        "
      >
        <h2 class="font-bold text-lilaText mt-4 uppercase">Público</h2>

        <!-- Línea 1: flags globales -->
        <div class="flex gap-x-4 justify-center mb-2">
          <app-button-select
            role="button"
            [attr.aria-pressed]="!!audienceForm.get('allPublic')?.value"
            [buttonText]="'Todos los públicos'"
            subText=""
            [active]="!!audienceForm.get('allPublic')?.value"
            (addClicked)="selectAudiencePrimary('ALL')"
            iconClass="uil-user"
          />
          <app-button-select
            role="button"
            [attr.aria-pressed]="
              !!audienceForm.get('hasAgeRecommendation')?.value
            "
            [buttonText]="'Hay una recomendación de edad'"
            subText=""
            [active]="!!audienceForm.get('hasAgeRecommendation')?.value"
            (addClicked)="selectAudiencePrimary('AGE')"
            iconClass="uil-info-circle"
          />
          <app-button-select
            role="button"
            [attr.aria-pressed]="!!audienceForm.get('hasRestriction')?.value"
            [buttonText]="'Hay alguna restricción'"
            subText=""
            [active]="!!audienceForm.get('hasRestriction')?.value"
            (addClicked)="selectAudiencePrimary('RESTRICTION')"
            iconClass="uil-ban"
          />
        </div>

        <!-- Línea 2: rangos de edad -->
        @if (audienceForm.get('hasAgeRecommendation')?.value) {
        <div class="mt-6">
          <div class="flex gap-x-4 justify-center mb-6">
            <app-button-select
              [buttonText]="'Bebés'"
              subText="0–3"
              [active]="!!audienceForm.get('ages.babies')?.value"
              (addClicked)="toggleAudience('ages.babies')"
              iconClass="uil-baby-carriage"
            />
            <app-button-select
              [buttonText]="'Infantil'"
              subText="4–11"
              [active]="!!audienceForm.get('ages.kids')?.value"
              (addClicked)="toggleAudience('ages.kids')"
              iconClass="uil-puzzle-piece"
            />
            <app-button-select
              [buttonText]="'Adolescentes'"
              subText="12–17"
              [active]="!!audienceForm.get('ages.teens')?.value"
              (addClicked)="toggleAudience('ages.teens')"
              iconClass="uil-user"
            />
            <app-button-select
              [buttonText]="'Adultos'"
              subText="18+"
              [active]="!!audienceForm.get('ages.adults')?.value"
              (addClicked)="toggleAudience('ages.adults')"
              iconClass="uil-18-plus"
            />
            <app-button-select
              [buttonText]="'Mayores'"
              subText="55+"
              [active]="!!audienceForm.get('ages.seniors')?.value"
              (addClicked)="toggleAudience('ages.seniors')"
              iconClass="uil-user-check"
            />
          </div>

          <div [formGroup]="audienceForm" class="box-input gap-x-4 pt-2">
            <label for="ageNote">Nota breve</label>
            <input
              id="ageNote"
              type="text"
              maxlength="120"
              class="flex-1"
              formControlName="ageNote"
              placeholder="p. ej., recomendado 8+ por contenido…"
            />
          </div>
        </div>
        }

        <!-- Restricciones -->
        @if (audienceForm.get('hasRestriction')?.value) {
        <div class="mt-6">
          <div class="flex gap-x-4 justify-center">
            <app-button-select
              [active]="!!audienceForm.get('restrictions.partnersOnly')?.value"
              (addClicked)="toggleRestriction('partnersOnly')"
              [buttonText]="'Exclusivamente socias'"
              subText="Debe formar parte de la asociación"
              iconClass="uil-exclamation-circle"
            />
            <app-button-select
              [active]="!!audienceForm.get('restrictions.womenOnly')?.value"
              (addClicked)="toggleRestriction('womenOnly')"
              [buttonText]="'Solo mujeres'"
              subText="Aforo o política del evento"
              iconClass="uil-exclamation-circle"
            />
            <app-button-select
              [active]="!!audienceForm.get('restrictions.other')?.value"
              (addClicked)="toggleRestriction('other')"
              [buttonText]="'Otra restricción'"
              subText="Especifica"
              iconClass="uil-question-circle"
            />
          </div>

          <div
            [formGroup]="audienceForm"
            formGroupName="restrictions"
            class="box-input gap-x-4 pt-6"
          >
            @if (audienceForm.get('restrictions.other')?.value) {
            <label for="otherText">Especificar reestricción</label>
            <input
              class="w-full"
              placeholder="Describe la restricción"
              formControlName="otherText"
            />
            }
          </div>
        </div>
        } @if (submitted && audienceErrorMessage) {
        <p
          class="is-invalid-text text-center"
          role="alert"
          aria-live="assertive"
        >
          {{ audienceErrorMessage }}
        </p>
        }
      </div>

      <!-- ADMISIÓN -->
      <div class="border-2 pt-2 px-4 pb-6 mb-6">
        <h2 class="font-bold text-lilaText mt-4 uppercase">Admisión</h2>
        <div class="flex justify-center gap-x-4 py-2">
          <app-button-select
            [buttonText]="'Evento gratuito'"
            [active]="eventTypeAccess === 'FREE'"
            (addClicked)="setEventTypeAccess('FREE')"
            iconClass="uil-social-distancing"
          />
          <app-button-select
            [buttonText]="'Evento de pago'"
            [active]="eventTypeAccess === 'TICKETS'"
            (addClicked)="setEventTypeAccess('TICKETS')"
            iconClass="uil-ticket"
          />
          <app-button-select
            [buttonText]="'Por determinar'"
            [active]="eventTypeAccess === 'UNSPECIFIED'"
            (addClicked)="setEventTypeAccess('UNSPECIFIED')"
            iconClass="uil-question-circle"
          />
        </div>

        @if (eventTypeAccess === 'TICKETS') {
        <div class="pt-4 px-4">
          <p class="text-[12px] text-center mb-10 text-lilaText px-4">
            Si el evento requiere de variedad de entradas, añade las diferentes
            categorías de público que mejor se adapten a tu evento (adultxs,
            niñxs, jubiladxs, socixs…) y especifica su precio. Para categorías
            gratuitas, introduce 0 como precio.
          </p>
          <div formArrayName="ticket_prices">
            @for (group of ticketPrices.controls; track $index; let i = $index)
            {
            <div [formGroupName]="i" class="box-input gap-x-4 pb-4">
              <label
                class="py-2 px-4 rounded-xl text-sm text-lilaText bg-lilaMuyClaro"
                >Tipo</label
              >
              <input
                formControlName="type"
                type="text"
                placeholder="Adultx, pubertx..."
              />
              <label
                class="py-2 px-4 rounded-xl text-sm text-lilaText bg-lilaMuyClaro"
                >Precio</label
              >
              <input formControlName="price" type="number" placeholder="€" />
              <button
                type="button"
                (click)="removeTicketPrice(i)"
                class="btn-danger"
              >
                Eliminar
              </button>
            </div>
            }
          </div>
          <div class="mb-4 flex gap-x-4 justify-start">
            <app-button-icon
              [buttonText]="'Añadir precio'"
              [iconClass]="'uil-plus'"
              (addClicked)="addTicketPrice()"
            ></app-button-icon>
          </div>
        </div>
        }
      </div>

      @if (eventTypeAccess !== 'TICKETS' ) {
      <div class="border-2 pt-2 px-4 pb-6 mb-6">
        <h2 class="font-bold text-lilaText mt-4 uppercase">Inscripción</h2>
        <div class="flex justify-center gap-x-4 py-2">
          <app-button-select
            [buttonText]="'Acceso ilimitado'"
            [active]="eventTypeInscription === 'UNLIMITED'"
            (addClicked)="setEventTypeInscription('UNLIMITED')"
            iconClass="uil-border-clear"
          />
          <app-button-select
            [buttonText]="'Requiere inscripción previa'"
            [active]="eventTypeInscription === 'INSCRIPTION'"
            (addClicked)="setEventTypeInscription('INSCRIPTION')"
            iconClass="uil-clipboard-notes"
          />
        </div>

        @if (eventTypeInscription === 'INSCRIPTION') {
        <div class="box-input gap-x-4 pt-4 px-4">
          <label for="inscription_method">Medio de registro</label>
          <textarea
            formControlName="inscription_method"
            placeholder="Escribe aquí..."
          ></textarea>
        </div>
        }
      </div>
      } @if (eventTypeAccess === 'TICKETS') {
      <div class="border-2 pt-2 px-4 pb-6 mb-6">
        <h2 class="font-bold text-lilaText mt-4 uppercase">
          Adquirir reserva / entrada
        </h2>

        <div class="box-input gap-x-4 pt-4 px-4">
          <label for="inscription_method">¿Cómo hacerlo?</label>
          <quill-editor
            formControlName="tickets_method"
            [modules]="quillModules"
            placeholder="Escribe aquí..."
            class="ql-container-small flex-1 text-sm focus:outline-none focus:ring focus:ring-blue-200"
          />
        </div>
      </div>
      }

      <!-- GESTIÓN -->
      <div class="border-2 pt-2 px-4 pb-6 mb-6">
        <h2 class="font-bold text-lilaText mt-4 uppercase">Gestión</h2>

        <div class="pt-6">
          <div class="mb-10 flex gap-x-4 justify-center">
            <app-button-icon
              [buttonText]="'Añadir organizador'"
              [iconClass]="'uil-plus'"
              (addClicked)="addOrganizer()"
            ></app-button-icon>
            <app-button-icon
              [buttonText]="'Añadir colaborador'"
              [iconClass]="'uil-plus'"
              (addClicked)="addCollaborator()"
            ></app-button-icon>
            <app-button-icon
              [buttonText]="'Añadir patrocinador'"
              [iconClass]="'uil-plus'"
              (addClicked)="addSponsor()"
            ></app-button-icon>
          </div>
        </div>
        <div class="mx-20">
          @if (showOrganizers) {
          <app-agent-array-control
            [formArray]="organizers"
            [agents]="agents"
            [label]="'Organizador'"
            (remove)="removeOrganizer($event)"
          ></app-agent-array-control>
          } @if (showCollaborators) {
          <app-agent-array-control
            [formArray]="collaborators"
            [agents]="agents"
            [label]="'Colaborador'"
            (remove)="removeCollaborator($event)"
          ></app-agent-array-control>
          } @if (showSponsors) {
          <app-agent-array-control
            [formArray]="sponsors"
            [agents]="agents"
            [label]="'Patrocinador'"
            (remove)="removeSponsor($event)"
          ></app-agent-array-control>
          }
        </div>
      </div>

      <!-- INFORMACIÓN ÚTIL + PARKING + FAQs -->
      <div class="border-2 pt-2 px-4 pb-6 mb-6">
        <h2 class="font-bold text-lilaText mt-4 uppercase">Información útil</h2>

        <!-- Acciones rápidas -->
        <div class="pt-6 mb-8 flex gap-x-4 justify-center">
          <!-- Toggle Puertas -->
          <app-button-icon
            [buttonText]="
              openDoorsEnabled
                ? 'Quitar hora de apertura'
                : 'Añadir hora de apertura de puertas'
            "
            [iconClass]="openDoorsEnabled ? 'uil-minus' : 'uil-plus'"
            (addClicked)="toggleDoorsOpen()"
          ></app-button-icon>

          <!-- Toggle Parking -->
          <app-button-icon
            [buttonText]="
              parkingEnabled
                ? 'Quitar información de aparcamiento'
                : 'Añadir información de aparcamiento'
            "
            [iconClass]="parkingEnabled ? 'uil-minus' : 'uil-plus'"
            (addClicked)="toggleParking()"
          ></app-button-icon>

          <!-- FAQs se queda igual (siempre +) -->
          <app-button-icon
            [buttonText]="'Añadir preguntas frecuentes'"
            [iconClass]="'uil-plus'"
            (addClicked)="addFaq()"
          ></app-button-icon>
        </div>

        <div class="mx-20 flex flex-col gap-y-6">
          <!-- Puertas: solo si se ha añadido -->
          @if (openDoorsEnabled) {
          <div class="mt-4">
            <h3 class="font-semibold text-lilaText mb-4">
              Información de apertura de puertas
            </h3>
            <div class="px-8">
              <div class="box-input gap-x-4">
                <label for="open_doors" class="!min-w-[50px]">Hora</label>
                <div class="w-20">
                  <input
                    formControlName="open_doors"
                    type="time"
                    placeholder="HH:mm"
                  />
                </div>
              </div>
            </div>
          </div>
          }

          <!-- Parking: solo si se ha añadido -->
          @if (parkingEnabled) {
          <div class="mt-4">
            <h3 class="font-semibold text-lilaText mb-4">
              Información de aparcamiento
            </h3>

            <div class="px-8">
              <div class="flex gap-x-4 justify-center">
                <app-button-select
                  [buttonText]="'Aparc. gratuito'"
                  subText="El espacio dispone de aparcamiento propio"
                  [active]="(formEvent.get('parking')?.value || '') === 'FREE'"
                  (addClicked)="setParking('FREE')"
                  iconClass="uil-car"
                />
                <app-button-select
                  [buttonText]="'Aparc. de pago'"
                  subText="El espacio dispone de aparcamiento propio"
                  [active]="(formEvent.get('parking')?.value || '') === 'PAID'"
                  (addClicked)="setParking('PAID')"
                  iconClass="uil-credit-card"
                />
                <app-button-select
                  [buttonText]="'No hay aparcamiento '"
                  subText="El espacio NO dispone de aparcamiento propio"
                  [active]="(formEvent.get('parking')?.value || '') === 'NONE'"
                  (addClicked)="setParking('NONE')"
                  iconClass="uil-car-slash"
                />
              </div>

              <div class="box-input gap-x-4 mt-8">
                <label for="parking_info">Información adicional</label>
                <textarea
                  formControlName="parking_info"
                  maxlength="300"
                  rows="3"
                  placeholder="Algunas zonas cercanas para aparcar..."
                ></textarea>
              </div>
            </div>
          </div>
          }

          <!-- FAQs: solo si hay elementos -->
          @if (faqs.length > 0) {
          <div class="mt-4">
            <h3 class="font-semibold text-lilaText mb-4">
              Preguntas frecuentes
            </h3>

            <p class="text-[12px] text-lilaText">
              Responde a las preguntas que puedan tener los asistentes sobre el
              evento, como la accesibilidad y los servicios.
            </p>

            <div formArrayName="faqs" class="flex flex-col gap-y-4 px-8">
              @for (fg of faqs.controls; track $index; let i = $index) {
              <div
                [formGroupName]="i"
                class="border-b border-1 border-lilaClaro p-4 flex gap-x-4"
              >
                <div
                  class="flex flex-col flex-1 border-r border-1 border-lilaClaro"
                >
                  <div class="box-input gap-x-4">
                    <label>Pregunta</label>
                    <div
                      class="flex flex-col flex-1 border-l border-1 border-lilaClaro p-4"
                    >
                      <input
                        formControlName="q"
                        type="text"
                        placeholder="¿Hay accesibilidad para sillas de ruedas?"
                        [ngClass]="{
                          'is-invalid': submitted && $any(fg).errors?.qRequired
                        }"
                      />
                    </div>
                  </div>
                  <div class="box-input gap-x-4">
                    <label>Respuesta</label>
                    <div
                      class="flex flex-col flex-1 border-l border-1 border-lilaClaro p-4"
                    >
                      <textarea
                        formControlName="a"
                        maxlength="300"
                        rows="3"
                        placeholder="Sí, el recinto cuenta con... (máx. 300 caracteres)"
                        [ngClass]="{
                          'is-invalid':
                            submitted &&
                            ($any(fg).errors?.aRequired ||
                              $any(fg).errors?.aTooLong)
                        }"
                      ></textarea>
                      <div class="text-right text-xs text-gray-500 mt-1">
                        {{ (fg.get("a")?.value || "").length }} / 300
                      </div>
                    </div>
                  </div>
                </div>
                <div class="flex items-center">
                  <button
                    type="button"
                    (click)="removeFaq(i)"
                    class="btn-danger"
                  >
                    Eliminar
                  </button>
                </div>
              </div>
              }
            </div>
          </div>
          }
        </div>
      </div>

      <!-- COMUNICACIÓN (webs, vídeos, redes) EN RAÍZ -->
      <div class="border-2 pt-2 px-4 pb-6 mb-6">
        <h2 class="font-bold text-lilaText mt-4 uppercase">
          Comunicación propia del evento
        </h2>

        <!-- Botones para añadir -->
        <div class="pt-6 mb-8 flex gap-x-4 justify-center">
          <app-button-icon
            class="mt-2"
            [buttonText]="'Página web'"
            [iconClass]="'uil-plus'"
            (addClicked)="addWebsite()"
          ></app-button-icon>

          <app-button-icon
            class="mt-2"
            [buttonText]="'Añadir vídeo'"
            [iconClass]="'uil-plus'"
            (addClicked)="addVideo()"
          ></app-button-icon>

          <app-button-icon
            class="mt-2"
            [buttonText]="'Añadir red'"
            [iconClass]="'uil-plus'"
            (addClicked)="addSocial()"
          ></app-button-icon>
        </div>

        <div class="mx-20">
          <!-- Websites -->
          @if (websites.length > 0) {
          <div class="mt-4" formArrayName="websites">
            <h3 class="font-semibold text-lilaText mb-4">
              Página web del evento
            </h3>
            <div class="flex flex-col gap-y-6 px-8">
              @for (w of websites.controls; track $index; let i = $index) {
              <app-link-item
                [group]="$any(w)"
                [submitted]="submitted"
                textPlaceholder="Título de la página web"
                (remove)="removeWebsite(i)"
              />
              }
            </div>
          </div>
          }
          <!-- Vídeos -->
          @if (videos.length > 0) {
          <div class="mt-8" formArrayName="videos">
            <h3 class="font-semibold text-lilaText mb-4">
              Vídeos (YouTube/Vimeo, opcional)
            </h3>

            <div class="flex flex-col gap-y-6 px-8">
              @for (v of videos.controls; track $index; let i = $index) {
              <app-link-item
                [group]="$any(v)"
                [submitted]="submitted"
                textPlaceholder="Trailer, aftermovie..."
                (remove)="removeVideo(i)"
              />
              }
            </div>
          </div>
          }

          <!-- Redes -->
          @if (socials.length > 0) {
          <div class="mt-8" formArrayName="socials">
            <h3 class="font-semibold text-lilaText mb-4">Redes sociales</h3>
            <div class="flex flex-col gap-y-6 px-8">
              @for (s of socials.controls; track $index; let i = $index) {
              <div [formGroupName]="i" class="flex gap-x-4">
                <div
                  class="flex flex-1 items-center gap-x-4 border-r border-1 border-lilaClaro pr-4"
                >
                  <div class="w-auto box-input">
                    <select formControlName="network" class="w-40">
                      <option value="web">Web</option>
                      <option value="instagram">Instagram</option>
                      <option value="facebook">Facebook</option>
                      <option value="x">X (Twitter)</option>
                      <option value="tiktok">TikTok</option>
                      <option value="youtube">YouTube</option>
                      <option value="threads">Threads</option>
                      <option value="bluesky">Bluesky</option>
                      <option value="linkedin">LinkedIn</option>
                    </select>
                  </div>

                  <div class="flex-1 box-input gap-x-4">
                    <label class="!min-w-[50px] text-right">URL</label>
                    <div class="flex flex-1">
                      <input
                        type="url"
                        formControlName="url"
                        placeholder="https://..."
                        [ngClass]="{
                          'is-invalid':
                            submitted && s.get('url')?.hasError('url')
                        }"
                      />
                    </div>
                  </div>
                </div>

                <div class="flex items-center">
                  <button
                    type="button"
                    class="btn-danger"
                    (click)="removeSocial(i)"
                  >
                    Eliminar
                  </button>
                </div>
              </div>
              }
            </div>
          </div>
          }
        </div>
      </div>

      <!-- STATUS -->
      <div class="border-2 pt-2 px-4 pb-6 mb-6">
        <h2 class="font-bold text-lilaText mt-4 uppercase">
          Estado del evento
        </h2>

        <div class="flex justify-center gap-x-4 my-6 mx-4">
          <app-button-select
            [buttonText]="'En curso'"
            subText="Todo sigue según lo provisto"
            [active]="eventTypeStatus === enumStatusEvent.EJECUCION"
            (addClicked)="setEventTypeStatus(enumStatusEvent.EJECUCION)"
            iconClass="uil-check-square"
          />
          <app-button-select
            [buttonText]="'Cancelado'"
            subText="No se puede llevar a cabo"
            [active]="eventTypeStatus === enumStatusEvent.CANCELADO"
            (addClicked)="setEventTypeStatus(enumStatusEvent.CANCELADO)"
            iconClass="uil-time_starts-circle"
          />
          <app-button-select
            [buttonText]="'Aplazado'"
            subText="Se postpone para otra fecha"
            [active]="eventTypeStatus === enumStatusEvent.APLAZADO"
            (addClicked)="setEventTypeStatus(enumStatusEvent.APLAZADO)"
            iconClass="uil-calendar-slash"
          />
          <app-button-select
            [buttonText]="'Agotado'"
            subText="No hay más aforo disponible"
            [active]="eventTypeStatus === enumStatusEvent.AGOTADO"
            (addClicked)="setEventTypeStatus(enumStatusEvent.AGOTADO)"
            iconClass="uil-exclamation-circle"
          />
        </div>

        @if (eventTypeStatus !== enumStatusEvent.EJECUCION) {
        <div class="box-input gap-x-4 pt-4 mx-20">
          <label for="status_reason">Motivos <br />cambio</label>
          <textarea
            formControlName="status_reason"
            placeholder="Escribe aquí..."
          ></textarea>
        </div>
        }
      </div>

      <!-- PUBLICACIÓN -->
      <div class="border-2 pt-2 px-4 pb-6 mb-6">
        <h2 class="font-bold text-lilaText mt-4 uppercase">Publicación</h2>

        <div class="pt-6 mb-8 flex gap-x-4 justify-center">
          <app-button-select
            [buttonText]="'Borrador'"
            subText="Guardar pero no visible"
            [active]="isDraft"
            (addClicked)="setDraft()"
            iconClass="uil-file-edit-alt"
          />
          <app-button-select
            [buttonText]="'Publicar ahora'"
            subText="Visible al guardar"
            [active]="isPublishNow"
            (addClicked)="publishNow()"
            iconClass="uil-check-circle"
          />
          <app-button-select
            [buttonText]="'Programar publicación'"
            subText="Se publicará automáticamente"
            [active]="isScheduled"
            (addClicked)="schedulePublication()"
            iconClass="uil-schedule"
          />
        </div>

        <!-- Muestra los inputs SOLO en modo programado -->
        @if (isScheduled) {
        <div class="flex gap-6 px-40">
          <div class="flex-1 box-input gap-x-4">
            <label for="publish_day">Fecha de publicación</label>
            <input type="date" formControlName="publish_day" />
          </div>
          <div class="box-input gap-x-4">
            <label for="publish_time" class="block !min-w-[50px]">Hora</label>
            <input type="time" formControlName="publish_time" />
          </div>
        </div>
        <p class="text-center text-xs text-gray-500 mt-2">
          Si cambias fecha/hora se programará; si las quitas, será “Publicar
          ahora”.
        </p>
        }
      </div>

      @if (formEvent.invalid && submitted) {
      <div class="flex justify-center">
        <div class="error">Hay algún campo incorrecto</div>
      </div>
      }

      <div class="flex justify-center">
        <button class="bg-black p-4 text-white" type="submit">
          {{ buttonAction }}
        </button>
      </div>
    </div>
  </form>
  }
</div>
