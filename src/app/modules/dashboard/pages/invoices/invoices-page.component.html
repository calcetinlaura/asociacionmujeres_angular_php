<!-- Zona sticky -->
<app-sticky-zone [height]="176">
  <app-dashboard-header
    [icon]="'uil uil-calculator'"
    [title]="'Contabilidad'"
    [number]="list.countSig()"
    [type]="'Movimientos'"
  />
  <div class="flex flex-1 flex-col justify-start">
    <app-filters
      [filters]="filtersFacade.filtersSig"
      [selected]="filtersFacade.selectedSig"
      (filterClicked)="filterSelected($event)"
    />
  </div>
</app-sticky-zone>

<!-- Zona principal -->
<div class="flex flex-col px-8 items-center">
  @if (invoicesFacade.isLoadingList$ | async) {
  <div class="flex justify-center items-center py-16">
    <app-spinner-loading />
  </div>
  } @else {
  <!-- SIEMPRE mostramos el grupo de pestañas -->
  <mat-tab-group
    (selectedTabChange)="tabActive($event)"
    [selectedIndex]="selectedIndex"
    class="flex w-full"
  >
    <!-- ──────────────────────────────── -->
    <!-- TAB 1: CONTABILIDAD COMPLETA -->
    <!-- ──────────────────────────────── -->
    <mat-tab label="Contabilidad completa">
      <div class="flex flex-col gap-y-8 py-8">
        <app-page-toolbar
          [addText]="'Añadir movimiento'"
          [columns]="headerListInvoices"
          [visibility]="col.columnVisSig"
          (add)="addNewInvoiceModal()"
          (search)="applyFilterWord($event)"
          (print)="printTableAsPdf()"
          (toggle)="col.toggleColumn($event)"
        >
          <app-icon-action
            [icon]="'uil-folder-download'"
            [tooltip]="'Descargar facturas'"
            (click)="downloadFilteredPdfs(false)"
          />
        </app-page-toolbar>

        @if (noDataYearSig()) {
        <div class="p-6 text-center text-gray-500 text-[12px]">
          No hay contabilidad registrada de ese año.
        </div>
        } @else {
        <div class="pb-4" #printArea>
          <h2 class="only-on-pdf print-title">Listado contabilidad</h2>
          <app-table
            [data]="list.processedSig()"
            [typeSection]="TypeList.Invoices"
            [headerColumns]="col.getVisibleColumns()"
            [columnVisibility]="col.columnVisSig()"
            [displayedColumns]="col.displayedColumnsSig()"
            (openModal)="onOpenModal($event)"
            [topHeader]="60"
            [printExcludeColumns]="['invoice_pdf', 'proof_pdf']"
            [showFooterEnabled]="false"
          />
        </div>
        }
      </div>
    </mat-tab>

    <!-- ──────────────────────────────── -->
    <!-- TAB 2: FACTURAS -->
    <!-- ──────────────────────────────── -->
    <mat-tab label="Facturas">
      <div class="flex flex-col gap-y-8 py-8">
        <app-page-toolbar
          [addText]="'Añadir movimiento'"
          [columns]="headerListInvoices"
          [visibility]="col.columnVisSig"
          (add)="addNewInvoiceModal()"
          (search)="applyFilterWord($event)"
          (print)="printTableAsPdf()"
          (toggle)="col.toggleColumn($event)"
        >
          <app-icon-action
            [icon]="'uil-folder-download'"
            [tooltip]="'Descargar facturas'"
            (click)="downloadFilteredPdfs(false)"
          />
        </app-page-toolbar>

        @if (noDataInvoicesSig()) {
        <div class="p-6 text-center text-gray-500">
          No hay facturas para el año seleccionado.
        </div>
        } @else {
        <div class="pb-4" #printArea>
          <h2 class="only-on-pdf print-title">Listado contabilidad</h2>
          <app-table
            [data]="list.processedSig()"
            [typeSection]="TypeList.Invoices"
            [headerColumns]="col.getVisibleColumns()"
            [columnVisibility]="col.columnVisSig()"
            [displayedColumns]="col.displayedColumnsSig()"
            (openModal)="onOpenModal($event)"
            [topHeader]="60"
            [printExcludeColumns]="['invoice_pdf', 'proof_pdf']"
          />
        </div>
        }
      </div>
    </mat-tab>

    <!-- ──────────────────────────────── -->
    <!-- TAB 3: TICKETS -->
    <!-- ──────────────────────────────── -->
    <mat-tab label="Tickets">
      <div class="flex flex-col gap-y-8 py-8">
        <app-page-toolbar
          [addText]="'Añadir movimiento'"
          [columns]="headerListInvoices"
          [visibility]="col.columnVisSig"
          (add)="addNewInvoiceModal()"
          (search)="applyFilterWord($event)"
          (print)="printTableAsPdf()"
        >
          <app-icon-action
            [icon]="'uil-folder-download'"
            [tooltip]="'Descargar tickets'"
            (click)="downloadFilteredPdfs(false)"
          />
        </app-page-toolbar>

        @if (noDataTicketsSig()) {
        <div class="p-6 text-center text-gray-500">
          No hay tickets para el año seleccionado.
        </div>
        } @else {
        <div class="pb-4" #printArea>
          <h2 class="only-on-pdf print-title">Listado contabilidad</h2>
          <app-table
            [data]="list.processedSig()"
            [typeSection]="TypeList.Invoices"
            [headerColumns]="col.getVisibleColumns()"
            [columnVisibility]="col.columnVisSig()"
            [displayedColumns]="col.displayedColumnsSig()"
            (openModal)="onOpenModal($event)"
            [topHeader]="60"
            [printExcludeColumns]="['invoice_pdf', 'proof_pdf']"
          />
        </div>
        }
      </div>
    </mat-tab>

    <!-- ──────────────────────────────── -->
    <!-- TAB 4: INGRESOS -->
    <!-- ──────────────────────────────── -->
    <mat-tab label="Ingresos">
      <div class="flex flex-col gap-y-8 py-8">
        <app-page-toolbar
          [addText]="'Añadir movimiento'"
          [columns]="headerListInvoices"
          [visibility]="col.columnVisSig"
          (add)="addNewInvoiceModal()"
          (search)="applyFilterWord($event)"
          (print)="printTableAsPdf()"
          (toggle)="col.toggleColumn($event)"
        >
          <app-icon-action
            [icon]="'uil-folder-download'"
            [tooltip]="'Descargar ingresos'"
            (click)="downloadFilteredPdfs(false)"
          />
        </app-page-toolbar>

        @if (noDataIncomesSig()) {
        <div class="p-6 text-center text-gray-500">
          No hay ingresos para el año seleccionado.
        </div>
        } @else{
        <div class="pb-4" #printArea>
          <h2 class="only-on-pdf print-title">Listado contabilidad</h2>
          <app-table
            [data]="list.processedSig()"
            [typeSection]="TypeList.Invoices"
            [headerColumns]="col.getVisibleColumns()"
            [columnVisibility]="col.columnVisSig()"
            [displayedColumns]="col.displayedColumnsSig()"
            (openModal)="onOpenModal($event)"
            [topHeader]="60"
            [printExcludeColumns]="['invoice_pdf', 'proof_pdf']"
          />
        </div>
        }
      </div>
    </mat-tab>
  </mat-tab-group>
  }
</div>

<!-- Modal -->
<app-modal-shell
  [visible]="modalVisibleSig()"
  [typeModal]="currentModalTypeSig()"
  [action]="currentModalActionSig()"
  [item]="currentItemSig()"
  (close)="onCloseModal()"
  (confirmDelete)="onDelete($event)"
  (sendFormInvoiceData)="sendFormInvoice($event)"
/>
