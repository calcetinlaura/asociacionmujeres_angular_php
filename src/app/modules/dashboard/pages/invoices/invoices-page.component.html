<!-- Zona sticky -->
<app-sticky-zone [height]="176">
  <app-dashboard-header
    [icon]="'uil uil-calculator'"
    [title]="'Contabilidad'"
    [number]="number"
    [type]="'Movimientos'"
  />
  <div class="flex flex-1 flex-col justify-start">
    <app-filters
      [filters]="filters"
      (filterClicked)="filterSelected($event)"
    ></app-filters>
  </div>
</app-sticky-zone>

<!-- Zona principal -->
<div class="flex flex-col px-8 items-center">
  @if (invoicesFacade.isLoading$ | async) {
  <div class="flex justify-center items-center py-16">
    <app-spinner-loading />
  </div>
  } @else { @if (hasInvoicesForYear) {
  <mat-tab-group
    (selectedTabChange)="tabActive($event)"
    [selectedIndex]="selectedIndex"
  >
    <mat-tab label="Contabilidad completa">
      <div class="flex flex-col gap-y-8 py-8">
        <ng-container *ngTemplateOutlet="invoiceToolbar"></ng-container>
        <ng-container *ngTemplateOutlet="templateTableInvoice"></ng-container>
      </div>
    </mat-tab>

    <mat-tab label="Facturas">
      <div class="flex flex-col gap-y-8 py-8">
        <ng-container *ngTemplateOutlet="invoiceToolbar"></ng-container>
        <ng-container *ngTemplateOutlet="templateTableInvoice"></ng-container>
      </div>
    </mat-tab>

    <mat-tab label="Tickets">
      <div class="flex flex-col gap-y-8 py-8">
        <ng-container *ngTemplateOutlet="invoiceToolbar"></ng-container>
        <ng-container *ngTemplateOutlet="templateTableInvoice"></ng-container>
      </div>
    </mat-tab>

    <mat-tab label="Ingresos">
      <div class="flex flex-col gap-y-8 py-8">
        <ng-container *ngTemplateOutlet="invoiceToolbar"></ng-container>
        <ng-container
          *ngTemplateOutlet="templateTableInvoice"
        ></ng-container></div
    ></mat-tab>
  </mat-tab-group>
  } @else {
  <div class="flex flex-col items-center justify-center py-16">
    <p class="text-lg text-gray-500 text-center">
      No hay contabilidad registrada de ese año.
    </p>
  </div>
  }

  <!-- Plantilla de tabla -->
  <ng-template #templateTableInvoice>
    <div class="pb-4" #printArea>
      <h2 class="only-on-pdf print-title">Listado contabilidad</h2>
      <app-table
        [data]="filteredInvoices"
        [typeSection]="typeSection"
        [typeModal]="typeModal"
        [headerColumns]="getVisibleColumns()"
        [columnVisibility]="columnVisibility"
        (openModal)="onOpenModal($event)"
        [topHeader]="60"
        [printExcludeColumns]="['invoice_pdf', 'proof_pdf']"
      />
    </div>
  </ng-template>

  <!-- Plantilla reutilizable para toolbar -->
  <ng-template #invoiceToolbar>
    <div class="flex gap-x-4">
      <app-button-icon
        [buttonText]="'Añadir movimiento'"
        [iconClass]="'uil-plus'"
        (addClicked)="addNewInvoiceModal()"
      />
      <app-input-search (onDebounce)="applyFilterWord($event)" class="flex-1" />
      <app-icon-action
        [icon]="'uil-folder-download'"
        [tooltip]="'Descargar facturas'"
        (click)="downloadFilteredPdfs(false)"
      />
      <app-icon-action
        [icon]="'uil-print'"
        [tooltip]="'Imprimir tabla'"
        (click)="printTableAsPdf()"
      />
      <app-button [buttonText]="'Filtrar columnas'" [menu]="columnsMenu" />
    </div>
  </ng-template>

  <!-- Menú separado (único, accesible por todos los tabs) -->
  <mat-menu #columnsMenu="matMenu">
    @for (column of headerListInvoices; track $index) {
    <button mat-menu-item>
      <mat-checkbox
        [checked]="columnVisibility[column.key]"
        (change)="toggleColumn(column.key)"
      >
        {{ column.title }}
      </mat-checkbox></button
    >}
  </mat-menu>
  }
</div>

<!-- Modal -->
@if (isModalVisible) {
<app-modal
  [item]="item"
  [typeModal]="typeModal"
  [action]="currentModalAction"
  (closeModal)="onCloseModal()"
  (confirmDelete)="onDelete($event)"
  (sendFormInvoiceData)="sendFormInvoice($event)"
></app-modal>
}
