<app-sticky-zone>
  <app-dashboard-header
    [icon]="'uil-euro-circle'"
    [title]="'Subvenciones'"
    [number]="number"
    [type]="'Subvenciones'"
  />
  <div class="flex flex-1 flex-col justify-start p-8 gap-y-8">
    <app-filters
      [filters]="filters"
      (filterClicked)="filterSelected($event)"
    ></app-filters>
    @if (showAllSubsidies) {
    <div class="flex gap-x-4 items-center">
      <app-button-icon
        [buttonText]="'A침adir subveci칩n'"
        [iconClass]="'uil-plus'"
        (addClicked)="addNewSubsidyModal()"
      />
      <app-input-search (onDebounce)="applyFilterWord($event)" class="flex-1" />

      <app-icon-action
        [icon]="'uil-print'"
        [tooltip]="'Imprimir tabla'"
        (click)="printTableAsPdf()"
      ></app-icon-action>

      <app-button
        [buttonText]="'Filtrar columnas'"
        [menu]="columnsMenu"
      ></app-button>

      <mat-menu #columnsMenu="matMenu">
        @for (column of headerListSubsidies; track $index) {
        <button mat-menu-item>
          <mat-checkbox
            [checked]="columnVisibility[column.key]"
            (change)="toggleColumn(column.key)"
          >
            {{ column.title }}
          </mat-checkbox>
        </button>
        }
      </mat-menu>
    </div>
    }
  </div>
</app-sticky-zone>
<div class="flex flex-col px-8">
  @if (subsidiesFacade.isLoading$ | async) {
  <app-spinner-loading />
  }@else { @if (showAllSubsidies) {
  <!--   <div class="pb-4" #printArea>
    <h2 class="only-on-pdf print-title">Listado subvenciones</h2>
    <app-table
      [data]="filteredSubsidies"
      [headerColumns]="getVisibleColumns()"
      [columnVisibility]="columnVisibility"
      [typeSection]="typeModal"
      [typeModal]="typeModal"
      (openModal)="onOpenModal($event)"
    ></app-table>
  </div> -->
  <div #printArea>
    <h2 class="only-on-pdf print-title">Listado subvenciones</h2>
    @for (group of (groupedByYear | keyvalue : sortYearsDesc); track group.key)
    {
    <div class="pb-4">
      <h3 class="year-title text-[14px] font-bold mb-4">A침o {{ group.key }}</h3>
      <div class="pb-4 flex">
        <app-table
          [data]="group.value"
          [headerColumns]="getVisibleColumns()"
          [columnVisibility]="columnVisibility"
          [typeSection]="typeModal"
          [typeModal]="typeModal"
          (openModal)="onOpenModal($event)"
        ></app-table>
      </div>
    </div>
    }
  </div>
  <hr />

  } @else { @if( visibleTabs.length > 0){
  <mat-tab-group
    (selectedTabChange)="tabActive($event)"
    [selectedIndex]="selectedIndex"
  >
    @for (tab of visibleTabs; track tab) {
    <mat-tab [label]="tab.label">
      <app-tab-subsidy
        [item]="tab.item"
        [loadInvoices]="true"
        (openModal)="onOpenModal($event)"
      ></app-tab-subsidy>
    </mat-tab>
    }
  </mat-tab-group>
  } @else {
  <div class="text-center text-gray-600 my-12 text-lg">
    No hay subvenciones registradas en este a침o.
  </div>
  }}}
</div>

<!-- Modal -->
@if (isModalVisible) {
<app-modal
  [item]="item"
  [typeModal]="typeModal"
  [typePage]="typePage"
  [action]="currentModalAction"
  (closeModal)="onCloseModal()"
  (confirmDelete)="onDelete($event)"
  (sendFormSubsidyData)="sendFormSubsidy($event)"
  (sendFormProjectData)="sendFormProject($event)"
  (sendFormInvoiceData)="sendFormInvoice($event)"
></app-modal>
}
