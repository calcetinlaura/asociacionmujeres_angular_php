<div>
  <div class="flex flex-col-reverse gap-y-8 lg:flex-row lg:gap-x-24 lg:gap-y-0">
    <div class="flex-1">
      <img
        appImgBroken
        [src]="(item.img ? item.img : '') | itemImage : typeModal"
        [alt]="item.name"
        class="imagen"
      />
    </div>

    <div class="flex flex-1 flex-col justify-between">
      <div
        class="inline-block border-b border-[#1C1C3A] pb-4 mb-4 md:pb-4 md:mb-8"
      >
        <app-text-title [text]="item.name" [align]="'left'"></app-text-title>
      </div>

      <div class="mb-4">
        <app-text-background [text]="item.category!"></app-text-background>
      </div>

      <div>
        <app-text-icon
          [icon]="'building'"
          [text]="item.address + ', ' + item.town + ' - ' + item.post_code"
        ></app-text-icon>
        <app-text-icon
          [icon]="'phone'"
          [text]="item.phone | phoneFormat"
        ></app-text-icon>
        <app-text-icon [icon]="'email'" [text]="item.email"></app-text-icon>
      </div>

      <hr class="my-4" />

      @if (item.observations) {
      <div class="flex flex-col gap-y-2 ml-4 pt-3">
        <app-text-editor [text]="item.observations"></app-text-editor>
      </div>
      }
    </div>
  </div>

  <hr class="mt-6 mb-6 border-b-1 border-[#1C1C3A]" />

  <p class="text-[18px] font-normal mb-6">Eventos</p>

  <div class="w-full">
    @if (loading) {
    <p class="text-sm text-gray-500 mt-2">Cargando eventos…</p>
    } @else if (eventsOfAgent.length > 0) {

    <!-- 🔹 Iterar por año (descendente) -->
    @for (year of (eventsByYear | keyvalue : keyDesc); track trackYear($index,
    year)) {
    <div class="mb-10">
      <p class="text-[14px] font-semibold">{{ year.key }}</p>

      <div class="mb-6">
        <!-- Lista tipo “tabla” ligera para eventos del año -->
        <div class="flex flex-col divide-y">
          @for (event of year.value; track trackEvent($index, event)) {
          <div
            class="group flex w-full gap-4 py-2 cursor-pointer rounded-xl transition-all duration-300 ease-out hover:-translate-y-0.5 hover:shadow-sm hover:bg-lilaClaro/10"
            (click)="onOpenEvent(event.id)"
            tabindex="0"
            (keyup.enter)="onOpenEvent(event.id)"
          >
            <div class="w-20 h-24 overflow-hidden flex-shrink-0 rounded-lg">
              @if (event.img) {
              <img
                [src]="event.img | itemImage : typeEvent"
                [alt]="event.title"
                class="object-cover w-full h-full transition-transform duration-300 ease-out group-hover:scale-[1.03]"
              />
              }
            </div>

            <div
              class="flex-1 grid grid-cols-1 sm:grid-cols-3 gap-2 items-center"
            >
              <div>
                <p class="text-[12px] font-semibold tracking-wide">
                  {{ event.title }}
                </p>
                @if (event.placeData?.name) {
                <p class="text-[12px] text-gray-600">
                  {{ event.placeData?.name }}
                </p>
                } @if (event.town) {
                <p class="text-[12px] text-gray-600">
                  @if (event.placeData?.address) {
                  <span>{{ event.placeData?.address }}, </span> }
                  {{ event.town }}
                </p>
                }
              </div>

              <div class="sm:text-center">
                @if (event.start) {
                <p class="text-[12px] text-gray-600">
                  {{
                    event.start
                      | date : "EEEE dd MMMM" : "" : "es-ES"
                      | titlecase
                  }}
                  <span *ngIf="event.time_start"
                    >&nbsp;| {{ event.time_start.slice(0, 5) }}h</span
                  >
                </p>
                }
              </div>

              <div class="sm:text-right">
                <!-- Si devuelves roles desde backend en event.agent_roles -->
                @if (event.organizer?.length) { @if (event.organizer &&
                event.organizer.length > 0) {
                <div class="mb-6 flex">
                  <div
                    class="border-r-[1px] border-lilaOscuro w-[60px] text-[10px] flex justify-start items-center"
                  >
                    Organiza
                  </div>
                  <div class="flex flex-col justify-center">
                    @for (organizer of event.organizer; track organizer) {
                    <p class="text-[10px] font-bold pl-3">
                      {{ organizer.name }}
                    </p>
                    }
                  </div>
                </div>
                } @if (event.collaborator && event.collaborator.length > 0) {
                <div class="mb-6 flex">
                  <div
                    class="border-r-[1px] border-lilaOscuro w-[60px] text-[10px] flex justify-start items-center"
                  >
                    Colabora
                  </div>

                  <div class="flex flex-col justify-center">
                    @for (colab of event.collaborator; track colab) {
                    <p class="text-[10px] font-bold pl-3">{{ colab.name }}</p>
                    }
                  </div>
                </div>
                } @if (event.sponsor && event.sponsor.length > 0) {
                <div class="mb-6 flex">
                  <div
                    class="border-r-[1px] border-lilaOscuro w-[60px] text-[10px] flex justify-start items-center"
                  >
                    Patrocina
                  </div>

                  <div class="flex flex-col justify-center">
                    @for (sponsor of event.sponsor; track sponsor) {
                    <p class="text-[10px] font-bold pl-3">{{ sponsor.name }}</p>
                    }
                  </div>
                </div>
                } }
              </div>
            </div>
          </div>
          }
        </div>
      </div>
    </div>
    }

    <!-- 🔹 Resumen final -->
    <div class="mb-4">
      <p class="text-[14px] font-semibold">Eventos totales por año</p>
    </div>
    <table class="w-full -collapse">
      <colgroup>
        <col class="w-[80px]" />
        <col class="w-[140px]" />
      </colgroup>
      <thead>
        <tr>
          <th class="p-2 text-center">Año</th>
          <th class="p-2 text-center">Nº Eventos</th>
        </tr>
      </thead>
      <tbody>
        @for (year of (eventsByYear | keyvalue : keyDesc); track
        trackYear($index, year)) {
        <tr class="hover:bg-gray-50">
          <td class="p-2 w-auto text-center">{{ year.key }}</td>
          <td class="p-2 text-center">{{ year.value.length }}</td>
        </tr>
        }
        <tr class="border-t">
          <td class="text-center text-[12px] font-semibold">TOTAL</td>
          <td class="p-2 text-center text-[12px] font-bold">
            {{ totalEvents }}
          </td>
        </tr>
      </tbody>
    </table>

    } @else {
    <!-- 🔹 Mensaje si no hay eventos -->
    <div class="mt-6">
      <app-text-background [text]="'Eventos'"></app-text-background>
      <p class="text-left text-gray-600 mt-4">
        No hay eventos registrados de este agente.
      </p>
    </div>
    }
  </div>
</div>
