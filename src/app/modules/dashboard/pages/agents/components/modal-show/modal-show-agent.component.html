<div>
  <div class="flex flex-col-reverse gap-y-8 lg:flex-row lg:gap-x-24 lg:gap-y-0">
    <div class="flex-1">
      <img
        appImgBroken
        [src]="(item.img ? item.img : '') | itemImage : typeModal"
        [alt]="item.name"
        class="imagen"
      />
    </div>

    <div class="flex flex-1 flex-col justify-between">
      <div
        class="inline-block border-b border-[#1C1C3A] pb-4 mb-4 md:pb-4 md:mb-8"
      >
        <app-text-title [text]="item.name" [align]="'left'"></app-text-title>
      </div>

      <div class="mb-4">
        <app-text-background [text]="item.category!"></app-text-background>
      </div>

      <div>
        <app-text-icon
          [icon]="'building'"
          [text]="item.address + ', ' + item.town + ' - ' + item.post_code"
        ></app-text-icon>
        <app-text-icon
          [icon]="'phone'"
          [text]="item.phone | phoneFormat"
        ></app-text-icon>
        <app-text-icon [icon]="'email'" [text]="item.email"></app-text-icon>
      </div>

      <hr class="my-4" />

      @if (item.observations) {
      <div class="flex flex-col gap-y-2 ml-4 pt-3">
        <app-text-editor [text]="item.observations"></app-text-editor>
      </div>
      }
    </div>
  </div>

  <hr class="mt-6 mb-6 border-b-1 border-[#1C1C3A]" />

  <p class="text-[18px] font-normal mb-6">Eventos</p>

  <div class="w-full">
    @if (loading) {
    <p class="text-sm text-gray-500 mt-2">Cargando eventos‚Ä¶</p>
    } @else if (eventsOfAgent.length > 0) {

    <!-- üîπ Iterar por a√±o (descendente) -->
    @for (year of (eventsByYear | keyvalue : keyDesc); track trackYear($index,
    year)) {
    <div class="mb-10">
      <p class="text-[14px] font-semibold">{{ year.key }}</p>

      <div class="mb-6">
        <!-- Lista tipo ‚Äútabla‚Äù ligera para eventos del a√±o -->
        <div class="flex flex-col divide-y">
          @for (event of year.value; track trackEvent($index, event)) {
          <div
            class="group flex w-full gap-4 py-1 cursor-pointer rounded-xl transition-all duration-300 ease-out hover:-translate-y-0.5 hover:shadow-sm hover:bg-lilaClaro/10"
            (click)="onOpenEvent(event.id)"
            tabindex="0"
            (keyup.enter)="onOpenEvent(event.id)"
          >
            <div class="w-20 h-24 overflow-hidden flex-shrink-0 rounded-lg">
              @if (event.img) {
              <img
                [src]="event.img | itemImage : typeEvent"
                [alt]="event.title"
                class="object-cover w-full h-full transition-transform duration-300 ease-out group-hover:scale-[1.03]"
              />
              }
            </div>

            <div class="flex-1 flex items-center gap-x-4">
              <div class="flex-1">
                <p class="text-[12px] font-semibold tracking-wide">
                  {{ event.title }}
                </p>
                @if (event.placeData?.name) {
                <p class="text-[12px] text-gray-600">
                  {{ event.placeData?.name }}
                </p>
                } @if (event.town) {
                <p class="text-[12px] text-gray-600">
                  {{ event.town }}
                </p>
                }
              </div>

              <div class="sm:text-center w-48">
                @if (event.start) {
                <p class="text-[12px] text-gray-600">
                  {{
                    event.start
                      | date : "EEEE dd MMMM" : "" : "es-ES"
                      | titlecase
                  }}
                </p>
                }
              </div>
              <div class="sm:text-center w-48">
                @if (event.time_start){
                <p>{{ event.time_start.slice(0, 5) }}h</p>
                }
              </div>
              <div class="sm:text-right w-auto pr-3">
                <!-- Si devuelves roles desde backend en event.agent_roles -->
                @let roles = rolesForAgent(event); @if (roles.length > 0) {
                <div class="inline-flex flex-wrap gap-1 sm:justify-end">
                  @for (role of roles; track role) {
                  <span
                    class="px-2 py-1 text-[10px] font-bold rounded bg-lilaClaro/20 text-lilaOscuro border border-lilaOscuro/30"
                  >
                    {{ role }}
                  </span>
                  }
                </div>
                }
              </div>
            </div>
          </div>
          }
        </div>
      </div>
    </div>
    }

    <!-- üîπ Resumen final -->
    <div class="mb-4">
      <p class="text-[14px] font-semibold">Eventos totales por a√±o</p>
    </div>
    <app-table-total-years [rows]="eventsRows" [totalCount]="totalEvents">
    </app-table-total-years>

    } @else {
    <!-- üîπ Mensaje si no hay eventos -->
    <div class="mt-6">
      <app-text-background [text]="'Eventos'"></app-text-background>
      <p class="text-left text-gray-600 mt-4">
        No hay eventos registrados de este agente.
      </p>
    </div>
    }
  </div>
</div>
